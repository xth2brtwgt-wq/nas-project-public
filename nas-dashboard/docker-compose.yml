services:
  nas-dashboard:
    build: .
    image: nas-dashboard:latest
    container_name: nas-dashboard
    user: root
    ports:
      - "9001:9000"
    volumes:
      # Dockerソケットをマウント（Dockerコマンド実行のため）
      - /var/run/docker.sock:/var/run/docker.sock
      # NAS環境のプロジェクトディレクトリをマウント
      - ~/nas-project:/nas-project:ro
      # 統合データディレクトリをマウント（ログファイルアクセスのため）
      # 認証データベースの書き込みのためにrw（読み書き可能）に変更
      - ~/nas-project-data:/nas-project-data:rw
      # ログディレクトリ
      - ~/nas-project-data/nas-dashboard/logs:/app/logs
      # バックアップディレクトリ
      - ~/nas-project-data/nas-dashboard/backups:/app/backups
      # レポートディレクトリ
      - ~/nas-project-data/nas-dashboard/reports:/app/reports
      # SSH鍵をマウント（UPS情報取得のため）
      - ~/.ssh:/root/.ssh
    environment:
      - TZ=Asia/Tokyo
      - FLASK_ENV=production
      - NAS_MODE=true
    env_file:
      - .env
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - nas-network

  # weekly-report-scheduler:  # 2重送信問題のため無効化
  #   build: .
  #   image: nas-dashboard:latest
  #   container_name: nas-dashboard-scheduler
  #   user: root
  #   volumes:
  #     # Dockerソケットをマウント（Dockerコマンド実行のため）
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     # NAS環境のプロジェクトディレクトリをマウント
  #     - ~/nas-project:/nas-project:ro
  #     # 統合データディレクトリをマウント（ログファイルアクセスのため）
  #     - ~/nas-project-data:/nas-project-data:ro
  #     # ログディレクトリ
  #     - ./logs:/app/logs
  #     # レポートディレクトリ
  #     - ~/nas-project-data/nas-dashboard/reports:/app/reports
  #   environment:
  #     - TZ=Asia/Tokyo
  #     - NAS_MODE=true
  #   env_file:
  #     - .env
  #   command: ["python", "scripts/weekly_report_scheduler.py"]
  #   restart: unless-stopped
  #   labels:
  #     - "com.centurylinklabs.watchtower.enable=true"
  #   networks:
  #     - nas-network

  monthly-ai-report-scheduler:
    build: .
    image: nas-dashboard:latest
    container_name: nas-dashboard-monthly-scheduler
    user: root
    volumes:
      # Dockerソケットをマウント（Dockerコマンド実行のため）
      - /var/run/docker.sock:/var/run/docker.sock
      # NAS環境のプロジェクトディレクトリをマウント
      - ~/nas-project:/nas-project:ro
      # 統合データディレクトリをマウント（ログファイルアクセスのため）
      - ~/nas-project-data:/nas-project-data:ro
      # ログディレクトリ
      - ~/nas-project-data/nas-dashboard/logs:/app/logs
      # レポートディレクトリ
      - ~/nas-project-data/nas-dashboard/reports:/app/reports
    environment:
      - TZ=Asia/Tokyo
      - NAS_MODE=true
    env_file:
      - .env
    command: ["python", "scripts/monthly_ai_report_scheduler.py"]
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - nas-network

networks:
  nas-network:
    external: true
