<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ãƒ­ã‚°ç›£è¦– - NAS-System</title>
    <!-- Faviconè¨­å®šï¼ˆSafariå¯¾å¿œå¼·åŒ–ï¼‰ -->
    <link rel="icon" href="/favicon.ico?v=2" type="image/x-icon" sizes="any">
    <link rel="icon" href="/static/favicon.svg?v=2" type="image/svg+xml">
    <link rel="shortcut icon" href="/favicon.ico?v=2">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=2">
    <link rel="mask-icon" href="/static/favicon.svg?v=2" color="#16a34a">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .log-container {
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .log-line {
            margin-bottom: 2px;
            word-wrap: break-word;
        }
        
        .log-info { color: #ffffff; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        .log-debug { color: #6c757d; }
        
        .log-analysis-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .auto-refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .log-section {
            margin-bottom: 30px;
        }
        
        .container-selector {
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            margin-left: 10px;
        }
        
        .log-stats {
            background-color: #f8f9fa;
            color: #333333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a href="/" class="navbar-brand mb-0 h1 text-white text-decoration-none" title="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹" style="display: flex; align-items: center;">
                <i class="fas fa-arrow-left me-2" style="font-size: 1.2em;"></i><span>ğŸ“‹ ãƒ­ã‚°ç›£è¦–</span>
            </a>
            <span class="navbar-text text-white">
                <small>v{{ version.version if version else '-' }}</small>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- è‡ªå‹•æ›´æ–°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div id="auto-refresh-indicator" class="auto-refresh-indicator" style="display: none;">
            <i class="fas fa-sync-alt fa-spin me-2"></i>
            <span id="refresh-status">æ›´æ–°ä¸­...</span>
        </div>

        <!-- ãƒ­ã‚°åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
        {% if is_admin == True %}
        <div class="log-section">
            <div class="row">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0"><i class="fas fa-robot me-2"></i>AI ãƒ­ã‚°åˆ†æ</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <select id="analysis-system-select" class="form-select">
                                        <option value="">ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button id="analyze-logs" class="btn btn-primary">
                                        <i class="fas fa-brain me-2"></i>åˆ†æå®Ÿè¡Œ
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button id="auto-analyze" class="btn btn-success">
                                        <i class="fas fa-magic me-2"></i>è‡ªå‹•åˆ†æ
                                    </button>
                                </div>
                            </div>
                            <div id="log-analysis-result" class="mt-3">
                                <div class="text-center">
                                    <div class="alert alert-primary">
                                        <i class="fas fa-robot me-2"></i>
                                        <strong>AI ãƒ­ã‚°åˆ†ææ©Ÿèƒ½</strong><br>
                                        ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ã€Œåˆ†æå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€ã€Œè‡ªå‹•åˆ†æã€ã§å…¨ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¸€æ‹¬åˆ†æã§ãã¾ã™
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="log-section">
            <div class="row">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h3 class="mb-0"><i class="fas fa-file-text me-2"></i>ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°</h3>
                        </div>
                        <div class="card-body">
                    
                    <!-- ã‚·ã‚¹ãƒ†ãƒ é¸æŠ -->
                    <div class="container-selector">
                        <div class="row">
                            <div class="col-md-6">
                                <select id="text-system-select" class="form-select">
                                    <option value="">ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <button id="refresh-text-logs" class="btn btn-primary">
                                    <i class="fas fa-sync-alt me-2"></i>æ›´æ–°
                                </button>
                            </div>
                        </div>
                    </div>
                    
                            <div class="log-stats">
                                <span id="text-log-stats">ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <div class="log-container" id="text-logs">
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dockerãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="log-section">
            <div class="row">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h3 class="mb-0"><i class="fab fa-docker me-2"></i>Dockerã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°</h3>
                        </div>
                        <div class="card-body">
                    
                    <!-- ã‚³ãƒ³ãƒ†ãƒŠé¸æŠ -->
                    <div class="container-selector">
                        <div class="row">
                            <div class="col-md-6">
                                <select id="container-select" class="form-select">
                                    <option value="">ã‚³ãƒ³ãƒ†ãƒŠã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <button id="refresh-docker-logs" class="btn btn-primary">
                                    <i class="fas fa-sync-alt me-2"></i>æ›´æ–°
                                </button>
                                <button id="toggle-auto-refresh" class="btn btn-outline-secondary">
                                    <i class="fas fa-play me-2"></i>è‡ªå‹•æ›´æ–°é–‹å§‹
                                </button>
                            </div>
                        </div>
                    </div>
                    
                            <div class="log-stats">
                                <span id="docker-log-stats">ã‚³ãƒ³ãƒ†ãƒŠã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            
                            <div class="log-container" id="docker-logs">
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    ã‚³ãƒ³ãƒ†ãƒŠã‚’é¸æŠã—ã¦ãã ã•ã„
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        // ãƒ­ã‚°åˆ†æã‚’å®Ÿè¡Œ
        async function analyzeLogs() {
            const systemId = document.getElementById('analysis-system-select').value;
            if (!systemId) {
                alert('ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const resultContainer = document.getElementById('log-analysis-result');
            const analyzeButton = document.getElementById('analyze-logs');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            resultContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">åˆ†æä¸­...</span>
                    </div>
                    <p class="mt-2">ãƒ­ã‚°åˆ†æã‚’å®Ÿè¡Œä¸­...</p>
                </div>
            `;
            analyzeButton.disabled = true;

            try {
                const response = await fetch('/api/logs/analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        system_id: systemId,
                        analysis_type: 'general'
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success' && data.analysis) {
                    resultContainer.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>åˆ†æå®Œäº†</h5>
                            <p><strong>ã‚·ã‚¹ãƒ†ãƒ :</strong> ${data.system_id}</p>
                            <p><strong>åˆ†ææ™‚åˆ»:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-brain me-2"></i>åˆ†æçµæœ</h6>
                            </div>
                            <div class="card-body">
                                <div class="log-analysis-content">${data.analysis}</div>
                            </div>
                        </div>
                    `;
                } else {
                    resultContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>åˆ†æã‚¨ãƒ©ãƒ¼</h5>
                            <p>${data.message || 'ãƒ­ã‚°åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ãƒ­ã‚°åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>åˆ†æã‚¨ãƒ©ãƒ¼</h5>
                        <p>ãƒ­ã‚°åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                    </div>
                `;
            } finally {
                analyzeButton.disabled = false;
            }
        }

        // åˆ†æç”¨ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadAnalysisSystems() {
            try {
                const response = await fetch('/api/logs/analysis-systems');
                const data = await response.json();
                
                const select = document.getElementById('analysis-system-select');
                select.innerHTML = '<option value="">ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>';
                
                if (data.success && data.systems) {
                    data.systems.forEach(system => {
                        const option = document.createElement('option');
                        option.value = system.id;
                        option.textContent = system.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åˆ†æç”¨ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è‡ªå‹•åˆ†æçµæœã‚’æŠ˜ã‚Šç•³ã¿å¯èƒ½ãªå½¢å¼ã§è¡¨ç¤º
        function displayAutoAnalysisResults(results) {
            const container = document.getElementById('log-analysis-result');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '<div class="auto-analysis-results">';
            html += '<h5 class="mb-3"><i class="fas fa-robot text-primary"></i> è‡ªå‹•åˆ†æçµæœ</h5>';
            
            results.forEach((result, index) => {
                const systemId = result.system_id || result.system || 'Unknown';
                const analysisData = result.analysis || {};
                const status = analysisData.status || 'unknown';
                const timestamp = result.timestamp || new Date().toISOString();
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³
                let statusClass = 'secondary';
                let statusIcon = 'fas fa-question-circle';
                if (status === 'healthy') {
                    statusClass = 'success';
                    statusIcon = 'fas fa-check-circle';
                } else if (status === 'warning') {
                    statusClass = 'warning';
                    statusIcon = 'fas fa-exclamation-triangle';
                } else if (status === 'critical') {
                    statusClass = 'danger';
                    statusIcon = 'fas fa-times-circle';
                }
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">
                                        <i class="${statusIcon} text-${statusClass}"></i>
                                        ${systemId} - ${analysisData.summary || 'åˆ†æçµæœ'}
                                    </h6>
                                    <small class="text-muted">${new Date(timestamp).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-${statusClass}" type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#analysis-${index}" 
                                        aria-expanded="false" 
                                        aria-controls="analysis-${index}">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        <div class="collapse" id="analysis-${index}">
                            <div class="card-body">
                                <div class="analysis-content">
                                    ${formatAnalysisContent(analysisData)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // æŠ˜ã‚Šç•³ã¿ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‹•çš„ã«æ›´æ–°
            document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
                button.addEventListener('click', function() {
                    const icon = this.querySelector('i');
                    const target = document.querySelector(this.getAttribute('data-bs-target'));
                    
                    if (target.classList.contains('show')) {
                        icon.className = 'fas fa-chevron-down';
                    } else {
                        icon.className = 'fas fa-chevron-up';
                    }
                });
            });
        }
        
        // åˆ†æå†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatAnalysisContent(analysisData) {
            let content = '';
            
            if (analysisData.overview) {
                content += `
                    <div class="mb-3">
                        <h6 class="text-primary"><i class="fas fa-eye"></i> æ¦‚è¦</h6>
                        <p class="mb-0">${analysisData.overview}</p>
                    </div>
                `;
            }
            
            if (analysisData.issues && analysisData.issues.length > 0) {
                content += `
                    <div class="mb-3">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> å•é¡Œç‚¹</h6>
                        <ul class="mb-0">
                            ${analysisData.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (analysisData.recommendations && analysisData.recommendations.length > 0) {
                content += `
                    <div class="mb-3">
                        <h6 class="text-info"><i class="fas fa-lightbulb"></i> æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                        <ul class="mb-0">
                            ${analysisData.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (analysisData.metrics) {
                content += `
                    <div class="mb-3">
                        <h6 class="text-success"><i class="fas fa-chart-line"></i> ç›£è¦–æŒ‡æ¨™</h6>
                        <div class="row">
                            ${Object.entries(analysisData.metrics).map(([key, value]) => `
                                <div class="col-md-6 mb-2">
                                    <strong>${key}:</strong> ${value}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (analysisData.details) {
                content += `
                    <div class="mb-3">
                        <h6 class="text-secondary"><i class="fas fa-info-circle"></i> è©³ç´°æƒ…å ±</h6>
                        <div class="analysis-details">
                            ${analysisData.details}
                        </div>
                    </div>
                `;
            }
            
            // æ—¢å­˜ã®åˆ†æçµæœï¼ˆæ–‡å­—åˆ—å½¢å¼ï¼‰ã‚‚å¯¾å¿œ
            if (typeof analysisData === 'string') {
                content += `
                    <div class="mb-3">
                        <h6 class="text-secondary"><i class="fas fa-info-circle"></i> åˆ†æçµæœ</h6>
                        <div class="analysis-details">
                            ${analysisData}
                        </div>
                    </div>
                `;
            }
            
            return content || '<p class="text-muted">è©³ç´°æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }

        // è‡ªå‹•åˆ†ææ©Ÿèƒ½
        async function autoAnalyze() {
            const resultContainer = document.getElementById('log-analysis-result');
            const autoAnalyzeButton = document.getElementById('auto-analyze');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            resultContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åˆ†æä¸­...</span>
                    </div>
                    <p class="mt-2">å…¨ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ­ã‚°åˆ†æã‚’å®Ÿè¡Œä¸­...</p>
                </div>
            `;
            autoAnalyzeButton.disabled = true;

            try {
                // åˆ©ç”¨å¯èƒ½ãªã‚·ã‚¹ãƒ†ãƒ ã‚’å–å¾—
                const response = await fetch('/api/logs/text');
                const data = await response.json();
                
                if (!data.success || !data.systems) {
                    throw new Error('ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const systems = data.systems;
                const analysisResults = [];

                // å„ã‚·ã‚¹ãƒ†ãƒ ã‚’é †æ¬¡åˆ†æ
                for (let i = 0; i < systems.length; i++) {
                    const system = systems[i];
                    
                    try {
                        // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°
                        resultContainer.innerHTML = `
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åˆ†æä¸­...</span>
                                </div>
                                <p class="mt-2">åˆ†æä¸­... (${i + 1}/${systems.length}) - ${system.name}</p>
                            </div>
                        `;
                        
                        const analysisResponse = await fetch('/api/logs/analysis', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                system_id: system.id,
                                analysis_type: 'comprehensive'
                            })
                        });
                        
                        const analysisData = await analysisResponse.json();
                        if (analysisData.status === 'success') {
                            analysisResults.push({
                                system_id: system.id,
                                system: system.name,
                                analysis: analysisData.analysis,
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            analysisResults.push({
                                system_id: system.id,
                                system: system.name,
                                analysis: {
                                    status: 'error',
                                    summary: 'åˆ†æã‚¨ãƒ©ãƒ¼',
                                    details: analysisData.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
                                },
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (error) {
                        console.error(`${system.name}ã®åˆ†æã‚¨ãƒ©ãƒ¼:`, error);
                        analysisResults.push({
                            system_id: system.id,
                            system: system.name,
                            analysis: {
                                status: 'error',
                                summary: 'åˆ†æã‚¨ãƒ©ãƒ¼',
                                details: error.message
                            },
                            timestamp: new Date().toISOString()
                        });
                    }
                }

                // çµæœã‚’è¡¨ç¤º
                displayAutoAnalysisResults(analysisResults);
                
            } catch (error) {
                console.error('è‡ªå‹•åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>è‡ªå‹•åˆ†æã‚¨ãƒ©ãƒ¼</h5>
                        <p>è‡ªå‹•åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>
                    </div>
                `;
            } finally {
                autoAnalyzeButton.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadDockerContainers();
            loadTextSystems();
            loadAnalysisSystems();
            
            // åˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('analyze-logs').addEventListener('click', analyzeLogs);
            document.getElementById('auto-analyze').addEventListener('click', autoAnalyze);
        });

        // Dockerã‚³ãƒ³ãƒ†ãƒŠä¸€è¦§ã‚’å–å¾—
        async function loadDockerContainers() {
            try {
                const response = await fetch('/api/docker/containers');
                const data = await response.json();
                
                const select = document.getElementById('container-select');
                select.innerHTML = '<option value="">ã‚³ãƒ³ãƒ†ãƒŠã‚’é¸æŠã—ã¦ãã ã•ã„...</option>';
                
                let containers = [];
                
                // é…åˆ—ãŒç›´æ¥è¿”ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (Array.isArray(data)) {
                    containers = data;
                }
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®å ´åˆ
                else if (data.success && data.containers) {
                    containers = data.containers;
                }
                
                // ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ 
                if (containers.length > 0) {
                    containers.forEach(container => {
                        // ã‚³ãƒ³ãƒ†ãƒŠåãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
                        if (container.name && container.name.trim()) {
                            const option = document.createElement('option');
                            option.value = container.name;
                            const status = container.status || container.state || 'Unknown';
                            option.textContent = `${container.name} (${status})`;
                            select.appendChild(option);
                        }
                    });
                } else {
                    // ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('ã‚³ãƒ³ãƒ†ãƒŠä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                const select = document.getElementById('container-select');
                select.innerHTML = '<option value="">ã‚³ãƒ³ãƒ†ãƒŠä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§ã‚’å–å¾—
        async function loadTextSystems() {
            try {
                const response = await fetch('/api/logs/text');
                const data = await response.json();
                
                const select = document.getElementById('text-system-select');
                select.innerHTML = '<option value="">ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>';
                
                if (data.success && data.systems) {
                    data.systems.forEach(system => {
                        const option = document.createElement('option');
                        option.value = system.id;
                        option.textContent = `${system.name} (${system.total_lines}è¡Œ)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
        async function loadTextLogs() {
            const systemId = document.getElementById('text-system-select').value;
            if (!systemId) {
                document.getElementById('text-logs').innerHTML = '<div class="text-center text-muted">ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                return;
            }

            try {
                const response = await fetch(`/api/logs/text/${systemId}`);
                const data = await response.json();
                const container = document.getElementById('text-logs');
                
                if (data.success && data.logs && data.logs.length > 0) {
                    let html = '<div class="log-stats">';
                    html += `<strong>ã‚·ã‚¹ãƒ†ãƒ :</strong> ${systemId} | `;
                    html += `<strong>ãƒ­ã‚°è¡Œæ•°:</strong> ${data.logs.length}`;
                    html += '</div>';
                    
                    data.logs.forEach(log => {
                        // ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°ã¯æ–‡å­—åˆ—ã®é…åˆ—ãªã®ã§ã€ãã®ã¾ã¾è¡¨ç¤º
                        const logClass = getLogLevelClass(log);
                        html += `<div class="log-entry ${logClass}">${log}</div>`;
                    });
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="text-center text-muted">ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('text-logs').innerHTML = '<div class="text-center text-muted">ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // Dockerãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
        async function loadDockerLogs() {
            const containerName = document.getElementById('container-select').value;
            if (!containerName) {
                document.getElementById('docker-logs').innerHTML = '<div class="text-center text-muted">ã‚³ãƒ³ãƒ†ãƒŠã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                return;
            }

            try {
                const response = await fetch(`/api/docker/logs/${containerName}`);
                const data = await response.json();
                
                const container = document.getElementById('docker-logs');
                const stats = document.getElementById('docker-log-stats');
                
                if (data.success && data.logs) {
                    let html = '';
                    data.logs.forEach(log => {
                        if (log.trim()) {
                            const lineClass = getLogLevelClass(log);
                            html += `<div class="log-line ${lineClass}">${log}</div>`;
                        }
                    });
                    container.innerHTML = html;
                    stats.textContent = `ã‚³ãƒ³ãƒ†ãƒŠ: ${containerName} | ãƒ­ã‚°è¡Œæ•°: ${data.logs.length}`;
                } else {
                    container.innerHTML = '<div class="text-center text-muted">ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                    stats.textContent = `ã‚³ãƒ³ãƒ†ãƒŠ: ${containerName} | ãƒ­ã‚°ãªã—`;
                }
            } catch (error) {
                console.error('Dockerãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('docker-logs').innerHTML = '<div class="text-center text-danger">ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼</div>';
            }
        }

        // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        function getLogLevelClass(log) {
            if (log.includes('ERROR') || log.includes('CRITICAL') || log.includes('FATAL')) {
                return 'log-error';
            } else if (log.includes('WARNING') || log.includes('WARN')) {
                return 'log-warning';
            } else if (log.includes('DEBUG')) {
                return 'log-debug';
            } else {
                return 'log-info';
            }
        }

        // è‡ªå‹•æ›´æ–°ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleAutoRefresh() {
            const button = document.getElementById('toggle-auto-refresh');
            const indicator = document.getElementById('auto-refresh-indicator');
            
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                button.innerHTML = '<i class="fas fa-play me-2"></i>è‡ªå‹•æ›´æ–°é–‹å§‹';
                button.className = 'btn btn-outline-secondary';
                indicator.style.display = 'none';
                isAutoRefresh = false;
            } else {
                autoRefreshInterval = setInterval(() => {
                    loadTextLogs();
                    loadDockerLogs();
                }, 5000);
                button.innerHTML = '<i class="fas fa-pause me-2"></i>è‡ªå‹•æ›´æ–°åœæ­¢';
                button.className = 'btn btn-warning';
                indicator.style.display = 'block';
                isAutoRefresh = true;
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('container-select').addEventListener('change', loadDockerLogs);
        document.getElementById('text-system-select').addEventListener('change', loadTextLogs);
    </script>
</body>
</html>
