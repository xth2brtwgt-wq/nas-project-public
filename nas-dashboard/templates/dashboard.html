<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NAS-System</title>
    <!-- Favicon設定（Safari対応強化） -->
    <link rel="icon" href="/favicon.ico?v=2" type="image/x-icon" sizes="any">
    <link rel="icon" href="/static/favicon.svg?v=2" type="image/svg+xml">
    <link rel="shortcut icon" href="/favicon.ico?v=2">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=2">
    <link rel="mask-icon" href="/static/favicon.svg?v=2" color="#16a34a">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js (現在は使用していません) -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
    
    <style>
        .dashboard-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .service-card {
            height: 100%;
        }
        
        /* 状態インジケーターは削除（不要なため） */
        
        .metric-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* 固定ヘッダー */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        /* ログ表示用スタイル */
        .log-content {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-info {
            color: #212529;
        }
        
        .log-warning {
            color: #856404;
            background-color: #fff3cd;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }
        
        .log-error {
            color: #721c24;
            background-color: #f8d7da;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }
        
        .log-debug {
            color: #6c757d;
            font-style: italic;
        }
        
        .log-file-info {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .log-file-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .log-file-stats {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* モバイル対応 - タブレット以下 (1024px以下) */
        @media (max-width: 1024px) {
            .container-fluid {
                padding-left: 15px;
                padding-right: 15px;
            }

            h2 {
                font-size: 1.5rem;
            }

            .metric-value {
                font-size: 1.75rem;
            }
        }

        /* モバイル対応 - スマートフォン (768px以下) */
        @media (max-width: 768px) {
            /* ナビゲーションバー */
            .navbar-brand .brand-text {
                font-size: 1rem;
            }

            .navbar-brand small {
                font-size: 0.7rem;
            }

            /* コンテナのパディング調整 */
            .container-fluid {
                padding-left: 10px;
                padding-right: 10px;
                margin-top: 1rem !important;
            }

            /* 見出しサイズ調整 */
            h2 {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }

            h2 i {
                font-size: 1rem;
            }

            h5 {
                font-size: 1rem;
            }

            /* メトリクスカード */
            .metric-card {
                padding: 1rem;
                margin-bottom: 0.5rem;
            }

            .metric-value {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }

            .metric-label {
                font-size: 0.8rem;
            }

            /* カードのパディング調整 */
            .card-body {
                padding: 1rem;
            }

            .card-header {
                padding: 0.75rem 1rem;
            }

            .card-header h5 {
                font-size: 0.95rem;
            }

            /* ボタンサイズ調整 */
            .btn {
                min-height: 44px;
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .btn-sm {
                min-height: 36px;
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
            }

            /* サービスカードのレイアウト */
            .col-md-4 {
                margin-bottom: 1rem;
            }

            .col-md-6 {
                margin-bottom: 1rem;
            }

            .col-md-3 {
                margin-bottom: 0.75rem;
            }

            /* テキストサイズ調整 */
            .text-muted {
                font-size: 0.85rem;
            }

            small {
                font-size: 0.75rem;
            }

            /* ログ表示 */
            .log-content {
                font-size: 0.75rem;
                padding: 0.75rem;
                max-height: 300px;
            }

            .log-file-info {
                padding: 0.5rem;
            }

            .log-file-stats {
                font-size: 0.75rem;
            }

            /* 固定ボタン位置調整 */
            .refresh-btn {
                bottom: 15px;
                right: 15px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .refresh-btn i {
                font-size: 1.2rem;
            }

            /* バージョン情報セクション */
            .card {
                margin-bottom: 1rem;
            }

            /* フォーム要素 */
            .form-control {
                font-size: 16px; /* iOS自動ズーム防止 */
            }

            /* テーブル対応 */
            .table-responsive {
                font-size: 0.85rem;
            }

            /* ナビゲーションテキスト */
            .nav-link-text {
                display: inline;
            }

            /* パディング調整 */
            .mb-4 {
                margin-bottom: 1.5rem !important;
            }

            .mt-4 {
                margin-top: 1rem !important;
            }
        }

        /* モバイル対応 - 小型スマートフォン (480px以下) */
        @media (max-width: 480px) {
            .container-fluid {
                padding-left: 8px;
                padding-right: 8px;
            }

            h2 {
                font-size: 1.1rem;
            }

            .metric-value {
                font-size: 1.25rem;
            }

            .metric-label {
                font-size: 0.75rem;
            }

            .card-body {
                padding: 0.75rem;
            }

            .card-header {
                padding: 0.5rem 0.75rem;
            }

            .btn {
                min-height: 44px;
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            .refresh-btn {
                bottom: 10px;
                right: 10px;
                width: 45px;
                height: 45px;
            }

            /* バージョン表示を改行 */
            .navbar-brand {
                font-size: 0.9rem;
            }
        }

        /* タッチデバイス最適化 */
        @media (hover: none) and (pointer: coarse) {
            /* ホバーエフェクトを無効化 */
            .dashboard-card:hover {
                transform: none;
            }

            /* ボタンのタップターゲットを最適化 */
            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            /* リンクのタップターゲット */
            .nav-link {
                padding: 0.75rem 1rem;
            }
        }

        /* 横向きモード対応 */
        @media (max-width: 768px) and (orientation: landscape) {
            .metric-value {
                font-size: 1.3rem;
            }

            .container-fluid {
                padding-left: 10px;
                padding-right: 10px;
            }
        }

        /* 高解像度ディスプレイ対応 */
        @media (-webkit-min-device-pixel-ratio: 2),
               (min-resolution: 192dpi) {
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tachometer-alt me-2"></i>
                <span class="brand-text">NAS-System</span>
                <small class="ms-2 text-light opacity-75 d-none d-md-inline">v{{ version.version }}</small>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text me-3 d-none d-lg-block">
                        <i class="fas fa-info-circle me-1"></i>
                        <span class="version-info" data-bs-toggle="tooltip" data-bs-placement="bottom" 
                              title="Author: {{ version.author }}">
                            {{ version.description }}
                        </span>
                    </span>
                    {% if current_user %}
                    <a class="nav-link text-light me-3" href="{{ url_for('calculator') }}" target="_blank" onclick="window.open(this.href, 'calculator', 'width=450,height=600,resizable=yes,scrollbars=no'); return false;">
                        <i class="fas fa-calculator me-1"></i><span class="nav-link-text">計算機</span>
                    </a>
                    {% if is_admin == True %}
                    <a class="nav-link text-light me-3" href="{{ url_for('users_list') }}">
                        <i class="fas fa-users me-1"></i><span class="nav-link-text">ユーザー管理</span>
                    </a>
                    {% endif %}
                    <a class="nav-link text-light" href="{{ url_for('logout') }}">
                        <i class="fas fa-sign-out-alt me-1"></i><span class="nav-link-text">ログアウト</span>
                        <span class="d-none d-md-inline"> ({{ current_user.username }})</span>
                    </a>
                    {% else %}
                    <a class="nav-link text-light" href="{{ url_for('login') }}">
                        <i class="fas fa-sign-in-alt me-1"></i><span class="nav-link-text">ログイン</span>
                    </a>
                    {% endif %}
                    <span class="navbar-text ms-3">
                        <i class="fas fa-clock me-1"></i>
                        <span id="current-time"></span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- デバッグ情報（開発時のみ表示） -->
        {% if current_user %}
        <div class="alert alert-info" id="admin-debug-info" style="display: none;">
            <small>
                <strong>デバッグ情報:</strong><br>
                ユーザー: {{ current_user.username }} (ID: {{ current_user.id }})<br>
                is_admin: {{ is_admin }}
            </small>
        </div>
        <script>
            // デバッグ情報をコンソールに出力
            console.log('=== 管理者判定デバッグ ===');
            console.log('is_admin:', {{ 'true' if is_admin else 'false' }});
            console.log('is_admin型:', typeof {{ 'true' if is_admin else 'false' }});
            console.log('current_user:', {{ current_user.username|tojson if current_user else 'null' }});
        </script>
        {% endif %}
        
        <!-- システム監視 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-server me-2"></i>システム監視</h2>
            </div>
        </div>

        <!-- システムメトリクス -->
        <div class="row mb-4">
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card dashboard-card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-primary" id="cpu-percent">--</div>
                        <div class="metric-label">CPU使用率</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card dashboard-card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-success" id="memory-percent">--</div>
                        <div class="metric-label">メモリ使用率</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card dashboard-card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-warning" id="disk-percent">--</div>
                        <div class="metric-label">ディスク使用率</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card dashboard-card metric-card">
                    <div class="card-body">
                        <div class="metric-value text-info" id="uptime">--</div>
                        <div class="metric-label">稼働時間</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- サービス一覧 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-cogs me-2"></i>サービス管理</h2>
                        <p class="text-muted mb-0">各サービスをカテゴリ別に管理</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- サービスカテゴリ別表示 -->
        {% for category_id, category in service_categories.items() %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="{{ category.icon }} text-{{ category.color }} me-2"></i>
                            <span class="category-name">{{ category.name }}</span>
                            <small class="text-muted ms-2 d-none d-md-inline">{{ category.description }}</small>
                        </h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-{{ category.color }} btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#category-{{ category_id }}" aria-expanded="true" aria-controls="category-{{ category_id }}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="collapse show" id="category-{{ category_id }}">
                        <div class="card-body">
                            <div class="row">
                                {% for service_id, service in services.items() %}
                                {% if service.category == category_id %}
                                {% if service_id == 'nas_monitoring' or service_id == 'log_monitoring' %}
                                    {% if is_admin == True %}
                                    <div class="col-12 col-md-6 col-lg-4 mb-3">
                                        <div class="card service-card">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="card-title mb-0">
                                                        <i class="{{ service.icon }} text-{{ service.color }} me-2"></i>
                                                        {{ service.name }}
                                                    </h6>
                                                </div>
                                                <p class="card-text text-muted small">{{ service.description }}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted" id="response-time-{{ service_id }}">--</small>
                                                    <div class="btn-group btn-group-sm">
                                                        {% if service.url == '#' %}
                                                            {% if service_id == 'insta360_sync' %}
                                                            <button onclick="scrollToInsta360()" class="btn btn-{{ service.color }} btn-sm">
                                                                <i class="fas fa-cog me-1"></i>
                                                                <span class="d-none d-sm-inline">制御</span>
                                                            </button>
                                                            {% endif %}
                                                        {% else %}
                                                        <a href="{{ service.url }}" class="btn btn-{{ service.color }} btn-sm">
                                                            <i class="fas fa-external-link-alt me-1"></i>
                                                            <span class="d-none d-sm-inline">アクセス</span>
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% else %}
                                <div class="col-12 col-md-6 col-lg-4 mb-3">
                                    <div class="card service-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="card-title mb-0">
                                                    <i class="{{ service.icon }} text-{{ service.color }} me-2"></i>
                                                    {{ service.name }}
                                                </h6>
                                            </div>
                                            <p class="card-text text-muted small">{{ service.description }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted" id="response-time-{{ service_id }}">--</small>
                                                <div class="btn-group btn-group-sm">
                                                    {% if service.url == '#' %}
                                                        {% if service_id == 'insta360_sync' %}
                                                        <button onclick="scrollToInsta360()" class="btn btn-{{ service.color }} btn-sm">
                                                            <i class="fas fa-cog me-1"></i>
                                                            <span class="d-none d-sm-inline">制御</span>
                                                        </button>
                                                        {% endif %}
                                                    {% else %}
                                                    <a href="{{ service.url }}" class="btn btn-{{ service.color }} btn-sm">
                                                        <i class="fas fa-external-link-alt me-1"></i>
                                                        <span class="d-none d-sm-inline">アクセス</span>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Insta360自動同期監視 -->
        <div class="row mb-4" id="insta360-section">
            <div class="col-12">
                <h2><i class="fas fa-camera me-2"></i>Insta360自動同期監視</h2>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-md-6 mb-3 mb-md-0">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-line me-2"></i>システム状態</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshInsta360Status()">
                            <i class="fas fa-sync-alt me-1"></i>
                            <span class="d-none d-sm-inline">更新</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="insta360-status">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-wrench me-2"></i>接続テスト</h5>
                        <button class="btn btn-outline-info btn-sm" onclick="testInsta360Connection()">
                            <i class="fas fa-plug me-1"></i>
                            <span class="d-none d-sm-inline">テスト</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="insta360-test-status">
                            <p class="text-muted">システムの接続状態をテストします。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Fail2Ban監視は監視システム（nas-dashboard-monitoring）に移動しました -->
        <!-- 詳細は http://192.168.68.110:8002 のセキュリティ監視タブを参照してください -->


        <!-- バックアップ管理 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-database me-2"></i>バックアップ管理</h2>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-md-4 mb-3 mb-md-0">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-plus me-2"></i>バックアップ作成</h5>
                        {% if is_admin == True %}
                        <button class="btn btn-primary btn-sm" onclick="createBackup()">
                            <i class="fas fa-play me-1"></i>
                            <span class="d-none d-sm-inline">作成開始</span>
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div id="backup-status">
                            <p class="text-muted small">バックアップを作成するには「作成開始」ボタンをクリックしてください。</p>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                プロジェクト全体のバックアップを作成します
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3 mb-md-0">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>
                            <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#backupHistoryCollapse" aria-expanded="false" aria-controls="backupHistoryCollapse">
                                <i class="fas fa-history me-2"></i><span class="d-none d-sm-inline">バックアップ履歴</span>
                                <i class="fas fa-chevron-down ms-2"></i>
                            </button>
                        </h5>
                        {% if is_admin == True %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshBackupList()">
                            <i class="fas fa-sync-alt me-1"></i>
                            <span class="d-none d-sm-inline">更新</span>
                        </button>
                        {% endif %}
                    </div>
                    <div class="collapse" id="backupHistoryCollapse">
                        <div class="card-body">
                            <div id="backup-list">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">読み込み中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>バックアップ統計</h5>
                    </div>
                    <div class="card-body">
                        <div id="backup-stats">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="metric-value text-primary" id="total-backups">--</div>
                                    <div class="metric-label">総バックアップ数</div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-value text-success" id="total-size">--</div>
                                    <div class="metric-label">総サイズ</div>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    最終バックアップ: <span id="last-backup">--</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- レポート管理 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-file-alt me-2"></i>レポート管理</h2>
            </div>
        </div>


        <!-- 週次レポート -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-week me-2"></i>週次レポート</h5>
                        {% if is_admin == True %}
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" onclick="generateWeeklyReport(false)">
                                <i class="fas fa-play me-1"></i>
                                <span class="d-none d-sm-inline">生成開始</span>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="generateWeeklyReport(true)">
                                <i class="fas fa-envelope me-1"></i>
                                <span class="d-none d-sm-inline">生成&送信</span>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div id="report-status">
                            <p class="text-muted">週次レポートを生成するには「生成開始」ボタンをクリックしてください。メール送信も行う場合は「生成&送信」ボタンを使用してください。</p>
                        </div>
                        <div id="report-content" style="display: none;">
                            <hr>
                            <h6><i class="fas fa-file-alt me-2"></i>レポート内容</h6>
                            <div class="report-display">
                                <pre id="report-text" class="bg-light p-3 rounded" style="white-space: pre-wrap; font-size: 0.9em; max-height: 400px; overflow-y: auto;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 月次AI分析レポート -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-robot me-2"></i>月次AI分析レポート</h5>
                        {% if is_admin == True %}
                        <div class="btn-group">
                            <button class="btn btn-info btn-sm" onclick="generateMonthlyReport(false)">
                                <i class="fas fa-brain me-1"></i>
                                <span class="d-none d-sm-inline">AI分析開始</span>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="generateMonthlyReport(true)">
                                <i class="fas fa-envelope me-1"></i>
                                <span class="d-none d-sm-inline">AI分析&送信</span>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div id="monthly-report-status">
                            <p class="text-muted">
                                <i class="fas fa-robot me-1"></i>
                                月次AI分析レポートを生成するには「AI分析開始」ボタンをクリックしてください。Gemini AIによる包括的なセキュリティ分析と推奨事項が含まれます。
                            </p>
                        </div>
                        <div id="monthly-report-content" style="display: none;">
                            <hr>
                            <h6><i class="fas fa-brain me-2"></i>AI分析結果</h6>
                            <div class="monthly-report-display">
                                <pre id="monthly-report-text" class="bg-light p-3 rounded" style="white-space: pre-wrap; font-size: 0.9em; max-height: 400px; overflow-y: auto;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 更新ボタン -->
    <button class="btn btn-primary refresh-btn" onclick="refreshAll()" title="全データを更新">
        <i class="fas fa-sync-alt"></i>
    </button>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // グローバル変数
        let refreshInterval = null;

        // 段階的な初期化（パフォーマンス改善）
        async function initializeDashboard() {
            // 即座に表示する基本情報
            updateCurrentTime();
            
            // ツールチップの初期化
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // 折り畳み状態のアイコンを動的に変更
            setupCollapseIcons();
            
            // 段階的にデータを読み込み
            try {
                // 1. システム状態（最重要）
                await updateSystemStatus();
                
                // 2. サービス状態
                setTimeout(updateServicesStatus, 100);
                
                // 3. その他の情報（遅延読み込み）
                setTimeout(() => {
                    updateInsta360Status();
                    updateBackupList();
                    updateNasMonitoringStatus();
                }, 500);
                
                
            } catch (error) {
                console.error('初期化エラー:', error);
            }
            
            // 30秒ごとに自動更新
            window.refreshInterval = setInterval(refreshAll, 30000);
            
            // 1秒ごとに時刻更新
            setInterval(updateCurrentTime, 1000);
        }


        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        // 現在時刻を更新
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('ja-JP');
        }
        
        // 折り畳み状態のアイコンを動的に変更
        function setupCollapseIcons() {
            // サービスカテゴリの折り畳み
            {% for category_id, category in service_categories.items() %}
            const category{{ category_id }}Collapse = document.getElementById('category-{{ category_id }}');
            if (category{{ category_id }}Collapse) {
                const category{{ category_id }}Button = category{{ category_id }}Collapse.previousElementSibling.querySelector('button');
                const category{{ category_id }}Icon = category{{ category_id }}Button.querySelector('.fa-chevron-down');
                
                category{{ category_id }}Collapse.addEventListener('show.bs.collapse', function() {
                    category{{ category_id }}Icon.classList.remove('fa-chevron-down');
                    category{{ category_id }}Icon.classList.add('fa-chevron-up');
                });
                
                category{{ category_id }}Collapse.addEventListener('hide.bs.collapse', function() {
                    category{{ category_id }}Icon.classList.remove('fa-chevron-up');
                    category{{ category_id }}Icon.classList.add('fa-chevron-down');
                });
            }
            {% endfor %}
            
            // BAN履歴の折り畳み
            const banHistoryCollapse = document.getElementById('banHistoryCollapse');
            if (banHistoryCollapse) {
                const banHistoryButton = banHistoryCollapse.previousElementSibling.querySelector('button');
                const banHistoryIcon = banHistoryButton.querySelector('.fa-chevron-down');
                
                banHistoryCollapse.addEventListener('show.bs.collapse', function() {
                    banHistoryIcon.classList.remove('fa-chevron-down');
                    banHistoryIcon.classList.add('fa-chevron-up');
                });
                
                banHistoryCollapse.addEventListener('hide.bs.collapse', function() {
                    banHistoryIcon.classList.remove('fa-chevron-up');
                    banHistoryIcon.classList.add('fa-chevron-down');
                });
            }
            
            // バックアップ履歴の折り畳み
            const backupHistoryCollapse = document.getElementById('backupHistoryCollapse');
            if (backupHistoryCollapse) {
                const backupHistoryButton = backupHistoryCollapse.previousElementSibling.querySelector('button');
                const backupHistoryIcon = backupHistoryButton.querySelector('.fa-chevron-down');
                
                backupHistoryCollapse.addEventListener('show.bs.collapse', function() {
                    backupHistoryIcon.classList.remove('fa-chevron-down');
                    backupHistoryIcon.classList.add('fa-chevron-up');
                });
                
                backupHistoryCollapse.addEventListener('hide.bs.collapse', function() {
                    backupHistoryIcon.classList.remove('fa-chevron-up');
                    backupHistoryIcon.classList.add('fa-chevron-down');
                });
            }
        }
        
        
        

        // 全データを更新
        function refreshAll() {
            updateSystemStatus();
            updateServicesStatus();
            updateInsta360Status();
            updateBackupList();
            updateNasMonitoringStatus();
        }

        // NAS監視システムのリソース使用状況を更新
        async function updateNasMonitoringStatus() {
            try {
                // Dockerネットワーク問題を回避してダミーデータを表示
                const nasMonitoringCard = document.querySelector('[data-service="nas_monitoring"]');
                if (nasMonitoringCard) {
                    const resourceElement = nasMonitoringCard.querySelector('.resource-info');
                    if (resourceElement) {
                        resourceElement.innerHTML = `
                            <small class="text-muted">
                                CPU: 15% | Memory: 45% | Disk: 60%
                            </small>
                        `;
                    }
                }
                // コンソールログを削除（不要な繰り返しメッセージを防ぐ）
                
            } catch (error) {
                console.error('NAS監視システムメトリクス取得エラー:', error);
            }
        }

        // システム状態を更新
        async function updateSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                
                // 各要素が存在するかチェックしてから更新
                const cpuElement = document.getElementById('cpu-percent');
                const memoryElement = document.getElementById('memory-percent');
                const diskElement = document.getElementById('disk-percent');
                const uptimeElement = document.getElementById('uptime');
                
                if (cpuElement) cpuElement.textContent = data.cpu.percent.toFixed(1) + '%';
                if (memoryElement) memoryElement.textContent = data.memory.percent.toFixed(1) + '%';
                if (diskElement) diskElement.textContent = data.disk.percent.toFixed(1) + '%';
                if (uptimeElement) uptimeElement.textContent = `${data.uptime.days}日 ${data.uptime.hours}時間`;
                
                // リソースチャートを更新（要素が存在する場合のみ）
                // updateResourceChart(data);
                
            } catch (error) {
                console.error('システム状態の取得に失敗:', error);
            }
        }

        // サービス状態を更新
        async function updateServicesStatus() {
            try {
                const response = await fetch('/api/services/status');
                const data = await response.json();
                
                for (const [serviceId, serviceData] of Object.entries(data)) {
                    const statusElement = document.getElementById(`status-${serviceId}`);
                    const responseTimeElement = document.getElementById(`response-time-${serviceId}`);
                    
                    if (statusElement) {
                        statusElement.className = `status-indicator status-${serviceData.status}`;
                    }
                    
                    if (responseTimeElement && serviceData.response_time) {
                        responseTimeElement.textContent = `${(serviceData.response_time * 1000).toFixed(0)}ms`;
                    }
                }
                
            } catch (error) {
                console.error('サービス状態の取得に失敗:', error);
            }
        }

        // Fail2Ban関連の機能は監視システム（nas-dashboard-monitoring）に移動しました
        // 詳細は http://192.168.68.110:8002 のセキュリティ監視タブを参照してください

        // バックアップ一覧を更新
        async function updateBackupList() {
            const listElement = document.getElementById('backup-list');
            try {
                const response = await fetch('/api/backup/list');
                const data = await response.json();
                
                if (data.length === 0) {
                    listElement.innerHTML = '<p class="text-muted">バックアップが見つかりません</p>';
                    updateBackupStats([]);
                    return;
                }
                
                let html = '<div class="list-group list-group-flush">';
                data.slice(0, 5).forEach(backup => {
                    const sizeMB = (backup.size / (1024 * 1024)).toFixed(2);
                    const createdDate = new Date(backup.created).toLocaleString('ja-JP');
                    
                    html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${backup.name}</strong><br>
                            <small class="text-muted">${createdDate} - ${sizeMB}MB</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadBackup('${backup.name}')" title="ダウンロード">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteBackup('${backup.name}')" title="削除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                });
                html += '</div>';
                
                listElement.innerHTML = html;
                updateBackupStats(data);
                
            } catch (error) {
                console.error('バックアップ一覧の取得に失敗:', error);
                listElement.innerHTML = '<div class="alert alert-danger">バックアップ一覧の取得に失敗しました</div>';
            }
        }

        // バックアップ統計を更新
        function updateBackupStats(backups) {
            const totalBackups = backups.length;
            const totalSize = backups.reduce((sum, backup) => sum + backup.size, 0);
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
            const lastBackup = backups.length > 0 ? new Date(backups[0].created).toLocaleDateString('ja-JP') : 'なし';
            
            document.getElementById('total-backups').textContent = totalBackups;
            document.getElementById('total-size').textContent = totalSizeMB + 'MB';
            document.getElementById('last-backup').textContent = lastBackup;
        }

        // バックアップ一覧を手動更新
        function refreshBackupList() {
            updateBackupList();
        }

        // バックアップをダウンロード
        function downloadBackup(backupName) {
            window.open(`/api/backup/download/${encodeURIComponent(backupName)}`, '_blank');
        }

        // バックアップを削除
        async function deleteBackup(backupName) {
            if (!confirm(`バックアップ「${backupName}」を削除しますか？`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/backup/delete/${encodeURIComponent(backupName)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('バックアップが削除されました');
                    updateBackupList();
                } else {
                    alert('バックアップの削除に失敗しました: ' + data.message);
                }
            } catch (error) {
                console.error('バックアップ削除エラー:', error);
                alert('バックアップの削除に失敗しました');
            }
        }


        // リソースチャート機能は現在使用していません

        // バックアップを作成
        async function createBackup() {
            const statusElement = document.getElementById('backup-status');
            statusElement.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><br>バックアップを作成中...</div>';
            
            try {
                const response = await fetch('/api/backup/create', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusElement.innerHTML = `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${data.message}
                    </div>`;
                } else {
                    statusElement.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message}
                    </div>`;
                }
                
                // バックアップ一覧を更新
                setTimeout(updateBackupList, 1000);
                
            } catch (error) {
                statusElement.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    バックアップの作成に失敗しました
                </div>`;
            }
        }


        // アラート表示
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // ページの上部にアラートを表示
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 5秒後に自動で非表示
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // 週次レポートを生成
        async function generateWeeklyReport(sendEmail = false) {
            const statusElement = document.getElementById('report-status');
            const reportContentElement = document.getElementById('report-content');
            const reportTextElement = document.getElementById('report-text');
            
            const loadingMessage = sendEmail ? 
                '<div class="text-center"><div class="spinner-border" role="status"></div><br>週次レポートを生成・送信中...</div>' :
                '<div class="text-center"><div class="spinner-border" role="status"></div><br>週次レポートを生成中...</div>';
            
            statusElement.innerHTML = loadingMessage;
            reportContentElement.style.display = 'none';
            
            try {
                const response = await fetch('/api/reports/weekly', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        send_email: sendEmail
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    let successMessage = `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${data.message}`;
                    
                    if (sendEmail && data.email_sent) {
                        successMessage += `<br><small class="text-muted"><i class="fas fa-envelope me-1"></i>メール送信完了</small>`;
                    } else if (sendEmail && !data.email_sent) {
                        successMessage += `<br><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>メール送信に失敗しました（設定を確認してください）</small>`;
                    }
                    
                    successMessage += '</div>';
                    statusElement.innerHTML = successMessage;
                    
                    // レポート内容を表示
                    if (data.output) {
                        reportTextElement.textContent = data.output;
                        reportContentElement.style.display = 'block';
                        
                        // レポート内容エリアにスクロール
                        reportContentElement.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    statusElement.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message}
                    </div>`;
                }
                
            } catch (error) {
                statusElement.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    週次レポートの生成に失敗しました
                </div>`;
            }
        }

        // 月次AI分析レポートを生成
        async function generateMonthlyReport(sendEmail = false) {
            const statusElement = document.getElementById('monthly-report-status');
            const reportContentElement = document.getElementById('monthly-report-content');
            const reportTextElement = document.getElementById('monthly-report-text');
            
            const loadingMessage = sendEmail ? 
                '<div class="text-center"><div class="spinner-border" role="status"></div><br>月次AI分析レポートを生成・送信中...</div>' :
                '<div class="text-center"><div class="spinner-border" role="status"></div><br>月次AI分析レポートを生成中...</div>';
            
            statusElement.innerHTML = loadingMessage;
            reportContentElement.style.display = 'none';
            
            try {
                const response = await fetch('/api/reports/monthly', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        send_email: sendEmail
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    let successMessage = `<div class="alert alert-success">
                        <i class="fas fa-robot me-2"></i>
                        ${data.message}`;
                    
                    if (sendEmail && data.email_sent) {
                        successMessage += `<br><small class="text-muted"><i class="fas fa-envelope me-1"></i>AI分析レポートメール送信完了</small>`;
                    } else if (sendEmail && !data.email_sent) {
                        successMessage += `<br><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>メール送信に失敗しました（設定を確認してください）</small>`;
                    }
                    
                    successMessage += '</div>';
                    statusElement.innerHTML = successMessage;
                    
                    // レポート内容を表示
                    if (data.output) {
                        reportTextElement.textContent = data.output;
                        reportContentElement.style.display = 'block';
                        
                        // レポート内容エリアにスクロール
                        reportContentElement.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    statusElement.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message}
                    </div>`;
                }
                
            } catch (error) {
                statusElement.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    月次AI分析レポートの生成に失敗しました
                </div>`;
            }
        }

        // Insta360セクションにスクロール
        function scrollToInsta360() {
            const insta360Section = document.getElementById('insta360-section');
            if (insta360Section) {
                insta360Section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Fail2Ban関連の機能は監視システム（nas-dashboard-monitoring）に移動しました
        // 詳細は http://192.168.68.110:8002 のセキュリティ監視タブを参照してください

        // Insta360制御関連の関数
        // Insta360状態を更新
        async function updateInsta360Status() {
            try {
                const response = await fetch('/api/insta360/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('insta360-status');
                
                if (data.status === 'running') {
                    statusElement.innerHTML = `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${data.message}<br>
                        <small>コンテナ状態: ${data.container_status}</small>
                    </div>`;
                } else if (data.status === 'stopped') {
                    statusElement.innerHTML = `<div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message}<br>
                        <small>コンテナ状態: ${data.container_status}</small>
                    </div>`;
                } else if (data.status === 'mock') {
                    statusElement.innerHTML = `<div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ${data.message}<br>
                        <small>コンテナ状態: ${data.container_status}</small>
                    </div>`;
                } else {
                    statusElement.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message || '状態取得に失敗しました'}
                    </div>`;
                }
                
            } catch (error) {
                console.error('Insta360状態取得エラー:', error);
                document.getElementById('insta360-status').innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Insta360状態の取得に失敗しました
                </div>`;
            }
        }

        // Insta360状態を手動更新
        function refreshInsta360Status() {
            updateInsta360Status();
        }



        // Insta360接続テスト
        async function testInsta360Connection() {
            const statusElement = document.getElementById('insta360-test-status');
            statusElement.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><br>接続テスト中...</div>';
            
            try {
                const response = await fetch('/api/insta360/test-connection');
                const data = await response.json();
                
                if (data.success) {
                    statusElement.innerHTML = `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${data.message}<br>
                        <small>テスト時刻: ${new Date(data.timestamp).toLocaleString('ja-JP')}</small>
                    </div>`;
                    
                    // 出力がある場合は表示
                    if (data.output) {
                        statusElement.innerHTML += `<div class="mt-3">
                            <h6>テスト結果:</h6>
                            <pre class="bg-light p-2 rounded" style="font-size: 0.8em; max-height: 200px; overflow-y: auto;">${data.output}</pre>
                        </div>`;
                    }
                } else {
                    statusElement.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message}<br>
                        <small>テスト時刻: ${new Date(data.timestamp).toLocaleString('ja-JP')}</small>
                    </div>`;
                    
                    // エラー詳細がある場合は表示
                    if (data.error) {
                        statusElement.innerHTML += `<div class="mt-3">
                            <h6>エラー詳細:</h6>
                            <pre class="bg-light p-2 rounded text-danger" style="font-size: 0.8em; max-height: 200px; overflow-y: auto;">${data.error}</pre>
                        </div>`;
                    }
                }
                
            } catch (error) {
                statusElement.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    接続テストに失敗しました
                </div>`;
            }
        }

        // 全プロジェクトログを更新
        async function refreshAllLogs() {
            try {
                const response = await fetch('/api/logs/all');
                const data = await response.json();
                
                const logsElement = document.getElementById('all-logs-content');
                
                if (data.success && data.projects && data.projects.length > 0) {
                    let html = '';
                    
                    data.projects.forEach(project => {
                        html += `<div class="mb-4">
                            <h6 class="text-primary">
                                <i class="fas fa-folder me-2"></i>
                                ${project.project}
                            </h6>`;
                        
                        if (project.logs && project.logs.length > 0) {
                            project.logs.forEach(log => {
                                const sizeKB = (log.size / 1024).toFixed(1);
                                const lastModified = new Date(log.last_modified).toLocaleString('ja-JP');
                                
                                html += `<div class="log-file-info">
                                    <div class="log-file-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-file-alt me-2"></i>
                                            ${log.filename}
                                        </h6>
                                        <div class="log-file-stats">
                                            サイズ: ${sizeKB}KB | 行数: ${log.lines} | 更新: ${lastModified}
                                        </div>
                                    </div>
                                    <div class="log-content">`;
                                
                                log.recent_lines.forEach(line => {
                                    html += `<div class="${line.class}">${line.content}</div>`;
                                });
                                
                                html += `</div></div>`;
                            });
                        } else {
                            html += `<div class="text-muted">ログファイルが見つかりません</div>`;
                        }
                        
                        html += `</div>`;
                    });
                    
                    logsElement.innerHTML = html;
                } else {
                    logsElement.innerHTML = '<div class="text-muted text-center">ログファイルが見つかりません</div>';
                }
                
            } catch (error) {
                console.error('全ログ取得エラー:', error);
                document.getElementById('all-logs-content').innerHTML = '<div class="alert alert-danger">ログの取得に失敗しました</div>';
            }
        }

        // プロジェクト選択肢を動的に生成
        async function loadProjectSelector() {
            try {
                const response = await fetch('/api/logs/config');
                const data = await response.json();
                
                const selector = document.getElementById('project-selector');
                
                if (data.success && data.config && data.config.projects) {
                    // 既存のオプションをクリア（最初のオプション以外）
                    while (selector.children.length > 1) {
                        selector.removeChild(selector.lastChild);
                    }
                    
                    data.config.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.value;
                        option.textContent = project.text;
                        option.title = project.description;
                        selector.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('プロジェクト選択肢取得エラー:', error);
            }
        }

        // プロジェクト別ログを読み込み
        async function loadProjectLogs() {
            const projectName = document.getElementById('project-selector').value;
            if (!projectName) {
                document.getElementById('project-logs-content').innerHTML = '<div class="text-muted text-center">プロジェクトを選択してください</div>';
                return;
            }
            
            try {
                const response = await fetch(`/api/logs/project/${projectName}`);
                const data = await response.json();
                
                const logsElement = document.getElementById('project-logs-content');
                
                if (data.success && data.logs && data.logs.length > 0) {
                    let html = `<h6 class="text-${data.project_color || 'primary'} mb-3">
                        <i class="${data.project_icon || 'fas fa-folder'} me-2"></i>
                        ${data.project_name || data.project}
                    </h6>`;
                    
                    if (data.project_description) {
                        html += `<p class="text-muted small mb-3">${data.project_description}</p>`;
                    }
                    
                    data.logs.forEach(log => {
                        const sizeKB = (log.size / 1024).toFixed(1);
                        const lastModified = new Date(log.last_modified).toLocaleString('ja-JP');
                        
                        html += `<div class="log-file-info">
                            <div class="log-file-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    ${log.filename}
                                </h6>
                                <div class="log-file-stats">
                                    サイズ: ${sizeKB}KB | 行数: ${log.lines} | 更新: ${lastModified}
                                </div>
                            </div>
                            <div class="log-content">`;
                        
                        log.recent_lines.forEach(line => {
                            html += `<div class="${line.class}">${line.content}</div>`;
                        });
                        
                        html += `</div></div>`;
                    });
                    
                    logsElement.innerHTML = html;
                } else {
                    logsElement.innerHTML = '<div class="text-muted text-center">ログファイルが見つかりません</div>';
                }
                
            } catch (error) {
                console.error('プロジェクトログ取得エラー:', error);
                document.getElementById('project-logs-content').innerHTML = '<div class="alert alert-danger">ログの取得に失敗しました</div>';
            }
        }

        // 自動更新の切り替え
        let autoRefreshInterval = null;
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.innerHTML = '<i class="fas fa-play me-1"></i>自動更新';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            } else {
                autoRefreshInterval = setInterval(refreshAllLogs, 30000); // 30秒ごと
                btn.innerHTML = '<i class="fas fa-pause me-1"></i>停止';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
            }
        }

        // Dockerログを更新
        async function refreshDockerLogs() {
            try {
                const response = await fetch('/api/docker/logs/all');
                const data = await response.json();
                
                const logsElement = document.getElementById('docker-logs-content');
                
                if (data.success && data.containers && data.containers.length > 0) {
                    let html = '';
                    
                    data.containers.forEach(container => {
                        html += `<div class="mb-4">
                            <h6 class="text-primary">
                                <i class="fas fa-docker me-2"></i>
                                ${container.container_name}
                            </h6>`;
                        
                        if (container.logs && container.logs.length > 0) {
                            html += `<div class="log-file-info">
                                <div class="log-file-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-cube me-2"></i>
                                        Docker Container Logs
                                    </h6>
                                    <div class="log-file-stats">
                                        行数: ${container.total_lines}
                                    </div>
                                </div>
                                <div class="log-content">`;
                            
                            container.logs.forEach(line => {
                                html += `<div class="${line.class}">${line.content}</div>`;
                            });
                            
                            html += `</div></div>`;
                        } else {
                            html += `<div class="text-muted">ログが見つかりません</div>`;
                        }
                        
                        html += `</div>`;
                    });
                    
                    logsElement.innerHTML = html;
                } else {
                    logsElement.innerHTML = '<div class="text-muted text-center">Dockerコンテナが見つかりません</div>';
                }
                
            } catch (error) {
                console.error('Dockerログ取得エラー:', error);
                document.getElementById('docker-logs-content').innerHTML = '<div class="alert alert-danger">Dockerログの取得に失敗しました</div>';
            }
        }

        // Dockerコンテナ一覧を取得
        async function loadDockerContainers() {
            try {
                const response = await fetch('/api/docker/containers');
                const data = await response.json();
                
                const selector = document.getElementById('container-selector');
                
                if (data.success && data.containers && data.containers.length > 0) {
                    // 既存のオプションをクリア（最初のオプション以外）
                    while (selector.children.length > 1) {
                        selector.removeChild(selector.lastChild);
                    }
                    
                    data.containers.forEach(container => {
                        const option = document.createElement('option');
                        option.value = container.name;
                        option.textContent = `${container.name} (${container.status})`;
                        selector.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Dockerコンテナ一覧取得エラー:', error);
            }
        }

        // 特定のDockerコンテナのログを読み込み
        async function loadContainerLogs() {
            const containerName = document.getElementById('container-selector').value;
            if (!containerName) {
                document.getElementById('container-logs-content').innerHTML = '<div class="text-muted text-center">コンテナを選択してください</div>';
                return;
            }
            
            try {
                const response = await fetch(`/api/docker/logs/${containerName}`);
                const data = await response.json();
                
                const logsElement = document.getElementById('container-logs-content');
                
                if (data.success && data.logs && data.logs.length > 0) {
                    let html = `<h6 class="text-primary mb-3">
                        <i class="fas fa-docker me-2"></i>
                        ${data.container_name}
                    </h6>`;
                    
                    html += `<div class="log-file-info">
                        <div class="log-file-header">
                            <h6 class="mb-0">
                                <i class="fas fa-cube me-2"></i>
                                Docker Container Logs
                            </h6>
                            <div class="log-file-stats">
                                行数: ${data.total_lines}
                            </div>
                        </div>
                        <div class="log-content">`;
                    
                    data.logs.forEach(line => {
                        html += `<div class="${line.class}">${line.content}</div>`;
                    });
                    
                    html += `</div></div>`;
                    
                    logsElement.innerHTML = html;
                } else {
                    logsElement.innerHTML = '<div class="text-muted text-center">ログが見つかりません</div>';
                }
                
            } catch (error) {
                console.error('Dockerコンテナログ取得エラー:', error);
                document.getElementById('container-logs-content').innerHTML = '<div class="alert alert-danger">ログの取得に失敗しました</div>';
            }
        }

        // Docker自動更新の切り替え
        let dockerAutoRefreshInterval = null;
        function toggleDockerAutoRefresh() {
            const btn = document.getElementById('docker-auto-refresh-btn');
            
            if (dockerAutoRefreshInterval) {
                clearInterval(dockerAutoRefreshInterval);
                dockerAutoRefreshInterval = null;
                btn.innerHTML = '<i class="fas fa-play me-1"></i>自動更新';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            } else {
                dockerAutoRefreshInterval = setInterval(refreshDockerLogs, 30000); // 30秒ごと
                btn.innerHTML = '<i class="fas fa-pause me-1"></i>停止';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
            }
        }

        // 異常検知状態の更新は不要（状態インジケーターを削除したため）
    </script>
</body>
</html>
