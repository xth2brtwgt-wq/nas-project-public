# 🔒 UFW設定の安全な変更手順

**作成日**: 2025-11-02  
**注意**: UGreen NASのシステム機能への影響を確認しながら設定

---

## ⚠️ 重要な注意事項

**UGreen NASのOS上のアプリケーション**が外部アクセスを使用している可能性があります。  
ファイアウォール設定を変更する前に、以下を確認してください：

1. どのポートがUGreen NASのシステム機能で使用されているか
2. 外部からアクセスが必要な機能があるか
3. 段階的な変更と動作確認

---

## 🔍 事前確認手順

### ステップ1: 現在開いているポートの確認

```bash
# NASにSSH接続
ssh -p 23456 AdminUser@192.168.68.110

# 現在リッスンしているポートを確認
sudo netstat -tulpn | grep LISTEN

# または
sudo ss -tulpn | grep LISTEN
```

**確認ポイント**:
- どのポートが開いているか
- どのプロセスが使用しているか
- UGreen NASのシステムプロセスが使用しているポートは何か

---

### ステップ2: ルーターのポート転送設定を確認

ルーターのポート転送設定で、どのポートが外部に公開されているかを確認してください。

**確認ポイント**:
- 外部からアクセスする必要があるのはHTTPS（8443）のみのはず
- 他のポート（9001, 8001など）は外部公開不要のはず
- UGreen NASの管理画面は内部ネットワークからのみアクセス

---

### ステップ3: UGreen NASの機能を確認

UGreen NASが提供している機能で、外部アクセスが必要なものがあるか確認：

1. **リモート管理機能**: 外部から管理画面にアクセスする必要があるか
2. **ファイル共有**: 外部からファイル共有にアクセスする必要があるか
3. **モバイルアプリ**: 外部から接続する必要があるか

**推奨**: UGreen NASの管理画面やドキュメントで確認

---

## 🛡️ 安全な設定手順（段階的アプローチ）

### フェーズ1: 不要なポートを特定

まず、現在のポート転送設定とUFW設定を比較：

```bash
# 現在のUFW設定を確認
sudo ufw status numbered

# ルーターで転送されているポートを確認（ルーター管理画面で）
# 転送されているポートのみを外部から許可すべき
```

**判断基準**:
- ✅ **許可**: ルーターでポート転送設定されているポート
- ❌ **削除**: ルーターでポート転送設定されていないポート
- ⚠️ **要確認**: UGreen NASのシステム機能が使用している可能性があるポート

---

### フェーズ2: テスト環境での確認

本番環境に影響を与えないよう、まず小規模な変更から：

```bash
# 1. まず、1つのポートを削除してテスト
# 例: 9001ポート（nas-dashboard）を削除
sudo ufw delete allow 9001/tcp

# 2. 動作確認
# - 内部ネットワークからはアクセスできるか
# - 外部からはアクセスできないか（意図通り）
# - UGreen NASの機能に影響がないか

# 3. 問題なければ、次のポートを削除
# 4. 問題があれば、元に戻す: sudo ufw allow 9001/tcp
```

---

### フェーズ3: 推奨設定（段階的）

#### ステップ1: SSH接続を確保

```bash
# SSH接続は必ず開けておく
sudo ufw allow 23456/tcp comment 'SSH Management'
```

#### ステップ2: 内部ネットワークを許可

```bash
# 内部ネットワーク（192.168.68.0/24）からのアクセスは全て許可
sudo ufw allow from 192.168.68.0/24 comment 'Internal Network'
```

#### ステップ3: 外部から必要なポートのみ許可

```bash
# HTTPS（Nginx Proxy Manager）のみ外部から許可
sudo ufw allow 8443/tcp comment 'HTTPS - Nginx Proxy Manager'

# Nginx Proxy Managerの管理ポート（内部ネットワークからのみアクセス可能にする）
# 既に内部ネットワークを許可しているので、追加不要
```

#### ステップ4: 不要なポートを削除（慎重に）

```bash
# まず、番号付きで確認
sudo ufw status numbered

# 1つずつ確認しながら削除
# 例: 9001ポートを削除
sudo ufw delete allow 9001/tcp

# 削除後、以下を確認:
# 1. 内部ネットワークからはアクセスできるか
# 2. UGreen NASの機能に影響がないか

# 問題なければ、次のポートを削除
```

---

## ⚠️ 危険なポートの特定

以下のポートは**UGreen NASのシステム機能**が使用している可能性があります：

### 確認が必要なポート

- **80/tcp**: HTTP（UGreen NASの管理画面など）
- **443/tcp**: HTTPS（UGreen NASの管理画面など）
- **9443/tcp**: カスタムHTTPSポート（UGreen NASの管理画面）
- **10443/tcp**: カスタムHTTPSポート（UGreen NASの管理画面）

**推奨対応**:
1. UGreen NASの管理画面でこれらのポートが使用されているか確認
2. 外部からアクセスする必要があるか確認
3. 必要なければ削除、必要な場合は内部ネットワークからのみアクセス可能にする

---

## 🔄 ロールバック手順

問題が発生した場合、すぐに元に戻せるよう準備：

```bash
# 特定のポートを元に戻す
sudo ufw allow 9001/tcp

# または、UFWを一時的に無効化（緊急時のみ）
sudo ufw disable

# 設定をリセット（注意: 全ての設定が削除されます）
sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing
```

---

## ✅ 推奨される最終設定

### 安全な設定例

```bash
# 1. デフォルト設定
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 2. 内部ネットワークを許可
sudo ufw allow from 192.168.68.0/24

# 3. SSH接続を許可
sudo ufw allow 23456/tcp comment 'SSH Management'

# 4. 外部からHTTPSのみ許可
sudo ufw allow 8443/tcp comment 'HTTPS - Nginx Proxy Manager'

# 5. UGreen NASの管理ポート（要確認）
# sudo ufw allow 8081/tcp comment 'Nginx Proxy Manager HTTP (internal only)'
# sudo ufw allow 8181/tcp from 192.168.68.0/24 comment 'Nginx Proxy Manager Admin (internal only)'
```

**重要なポイント**:
- 内部ネットワーク（192.168.68.0/24）からのアクセスは全て許可
- 外部からのアクセスはHTTPS（8443）のみ
- UGreen NASの管理ポートは内部ネットワークからのみ

---

## 📝 チェックリスト

ファイアウォール設定変更前の確認：

- [ ] 現在開いているポートを確認済み
- [ ] ルーターのポート転送設定を確認済み
- [ ] UGreen NASの機能で外部アクセスが必要なものがないか確認済み
- [ ] ロールバック手順を確認済み
- [ ] 段階的な変更計画を作成済み
- [ ] テスト環境で確認済み（可能な場合）

---

## 🔍 トラブルシューティング

### 設定変更後に問題が発生した場合

1. **SSH接続が切れた場合**
   - 内部ネットワークから直接NASにアクセス
   - または、物理的にNASにアクセス

2. **UGreen NASの機能が動かなくなった場合**
   - 該当するポートを元に戻す
   - または、内部ネットワークからのアクセスを許可

3. **アプリケーションにアクセスできなくなった場合**
   - 内部ネットワークからはアクセスできるか確認
   - 外部からのアクセスはNginx Proxy Manager経由で確認

---

**作成日**: 2025-11-02  
**更新日**: 2025-11-02  
**作成者**: AI Assistant

