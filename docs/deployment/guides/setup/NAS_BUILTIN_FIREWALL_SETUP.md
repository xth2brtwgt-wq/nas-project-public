# 🔒 NAS組み込みファイアウォール設定ガイド

**作成日**: 2025-01-27  
**対象**: UGreen DXP2800 NAS環境（組み込みファイアウォール機能を使用）

---

## 📋 概要

NASの組み込みファイアウォール機能を使用して、外部アクセス時のセキュリティ対策を設定します。GUIで簡単に設定でき、通知機能も統合されています。

---

## 🚀 設定手順

### ステップ1: NAS管理画面にアクセス

1. **NAS管理画面にアクセス**
   - 内部ネットワークから: `http://192.168.68.110`
   - または、NASの管理用URLにアクセス

2. **セキュリティ設定に移動**
   - 左メニューから「セキュリティ」を選択
   - 「ファイアウォール」タブをクリック

### ステップ2: ファイアウォールを有効化

1. **ファイアウォール機能を有効化**
   - 「ファイアウォール」セクションのトグルスイッチを**オン**にする
   - 説明文: 「ファイアウォールを有効にすると、不正なログインを防止し、特定のIPアドレスによる特定のネットワークポートへのアクセスを許可または拒否して、サービスへのアクセスを制御します。」

2. **ファイアウォール通知を有効化（推奨）**
   - 「ファイアウォール通知」のチェックボックスを**オン**にする
   - 説明文: 「ファイアウォールがアプリまたはサービスをブロックした場合、通知を送信し、迅速に解除できるオプションを提供します。」

### ステップ3: ファイアウォールルールの作成

「新規ルール」ボタンをクリックして、以下の3つのルールを順番に作成します。

#### ルール1: 内部ネットワークからの全アクセスを許可

**目的**: 内部ネットワーク（自宅のPCやスマートフォン）からのアクセスを制限なく受け入れる

**設定内容**:
- **権限**: **許可** を選択
- **ネットワーク接続**: デフォルト（すべて）のまま、または内部ネットワーク用のインターフェースを選択
- **ポート**: **すべて** を選択
- **ソースIP**: **特定のIPアドレス** を選択
  - 「選択」ボタンをクリック
  - 「サブネット」を選択（ラジオボタンで選択）
  - **IPアドレス**の入力フィールドに: `192.168.68.0` と入力
  - **ネットワークプレフィックス長**の入力フィールドに: `24` と入力
    - これで `192.168.68.0/24` の範囲が指定されます
  - 「OK」をクリック
- 「OK」をクリックしてルールを保存

**特定のIPアドレスの入力方法**:
1. 「ソースIP」で「特定のIPアドレス」を選択
2. 「選択」ボタンをクリック
3. 表示されるダイアログで、以下のいずれかを選択：
   - **サブネット**: IPアドレス範囲を指定（例: `192.168.68.0/24`）
     - IPアドレス: `192.168.68.0`
     - ネットワークプレフィックス長: `24`
   - **単一ホスト**: 特定の1つのIPアドレスのみを指定
     - IPアドレス: `192.168.68.100`
   - **IPアドレス範囲**: 開始IPと終了IPを指定
     - 開始IP: `192.168.68.1`
     - 終了IP: `192.168.68.254`
4. 「OK」をクリックして設定を確定

**このルールにより、内部ネットワークから以下のポートにアクセス可能になります**:
- 9001: nas-dashboard
- 8001: amazon-analytics
- 8080: document-automation
- 5002: meeting-minutes-byc
- 3002: nas-dashboard-monitoring (frontend)
- 8002: nas-dashboard-monitoring (backend)
- 8111: youtube-to-notion
- 8181: Nginx Proxy Manager Admin

---

#### ルール2: 外部からのHTTPS（8443）アクセスを許可

**目的**: Nginx Proxy Managerを介した安全な外部アクセス（ウェブサービスなど）を許可

**設定内容**:
- **権限**: **許可** を選択
- **ネットワーク接続**: デフォルト（すべて）のまま、または外部アクセスを受け付けるインターフェースを選択
- **ポート**: **カスタマイズ** を選択
  - 入力フィールドに `8443` と入力
  - **入力形式の例**:
    - `8443` （最もシンプルな形式、TCPがデフォルト）
    - `8443/tcp` （TCPプロトコルを明示的に指定）
    - `8443/tcp,8443/udp` （TCPとUDPの両方を許可する場合）
- **タイプ**: **ターゲットポート** を選択
  - ⚠️ **重要**: 外部からのHTTPS（8443）アクセスを許可する場合は、**「ターゲットポート」**を選択してください
  - **「ターゲットポート」**: NAS側で待ち受けるポート（宛先ポート）を指定します
  - **「ソースポート」**: クライアント側が使用するポートを指定します（通常は動的に割り当てられるため、指定する必要はありません）
- **ソースIP**: **すべて** を選択（外部からのアクセスはどのIPからでも受け付けるため）
- 「OK」をクリックして保存

**ポートカスタマイズの入力方法**:
1. 「ポート」セクションで「カスタマイズ」を選択
2. 表示される入力フィールドに直接ポート番号を入力
   - 例: `8443` と入力
   - プロトコル（TCP/UDP）を指定する場合は `8443/tcp` と入力
3. 入力後、他の設定項目に進む

---

#### ルール3: 外部からのSSH（23456）アクセスを許可

**目的**: NASをリモートで管理するためのSSHアクセスを許可

**設定内容**:
- **権限**: **許可** を選択
- **ネットワーク接続**: デフォルト（すべて）のまま、または外部アクセスを受け付けるインターフェースを選択
- **ポート**: **カスタマイズ** を選択
  - 入力フィールドに `23456` と入力
  - **入力形式の例**:
    - `23456` （最もシンプルな形式、TCPがデフォルト）
    - `23456/tcp` （TCPプロトコルを明示的に指定）
- **ソースIP**: **すべて** を選択
  - ⚠️ **セキュリティをさらに高める場合**: 特定の管理用IPアドレスのみを許可することも検討できます
    - その場合は「特定のIPアドレス」を選択
    - 「選択」ボタンをクリック
    - 「サブネット」を選択し、管理者の固定IPアドレス範囲を入力（例: `123.45.67.0/24`）
    - または「単一ホスト」を選択し、管理者の固定IPアドレスを入力（例: `123.45.67.89`）
- 「OK」をクリックして保存

**ポートカスタマイズの入力方法**:
1. 「ポート」セクションで「カスタマイズ」を選択
2. 表示される入力フィールドに直接ポート番号を入力
   - 例: `23456` と入力
   - プロトコル（TCP/UDP）を指定する場合は `23456/tcp` と入力
3. 入力後、他の設定項目に進む

---

### ルールの優先順位について

**重要**: ファイアウォールのルールは通常、上から順に処理されます。

**推奨されるルールの順序**:
1. **内部ネットワークからの全アクセスを許可**（最も広範なルール）
2. **外部からのHTTPS（8443）アクセスを許可**（特定ポート）
3. **外部からのSSH（23456）アクセスを許可**（特定ポート）

この順序により、内部ネットワークからのアクセスが優先され、外部からのアクセスは特定のポートのみが許可されます。

**ルールの順序を変更する方法**:
- ルール一覧画面で、ルールをドラッグ&ドロップで並び替えられる場合があります
- または、ルールを削除して再作成する順序で調整してください

---

## 🔍 推奨設定

### 基本ポリシー

- **外部からの接続**: デフォルトで拒否
- **内部からの接続**: デフォルトで許可
- **外部から許可するポート**: HTTPS（8443）とSSH（23456）のみ

### ポート設定の優先順位

1. **SSH（23456）**: 管理用のため、外部からも許可（必要に応じて）
2. **HTTPS（8443）**: 外部アクセス用のため、外部から許可
3. **その他のポート**: 内部ネットワークからのみ許可

---

## ⚠️ 重要な注意事項

### SSH接続を確保する

ファイアウォールを有効化する前に、必ずSSHポート（23456）を許可するルールを作成してください。SSH接続が切断されると、リモートからアクセスできなくなります。

**推奨される設定順序**:
1. まず、SSH（23456）の許可ルールを作成
2. 次に、内部ネットワーク（192.168.68.0/24）の許可ルールを作成
3. 最後に、HTTPS（8443）の許可ルールを作成
4. すべてのルールを作成した後、ファイアウォールを有効化

### 設定の確認

ファイアウォールを有効化した後、必ず設定を確認してください：

1. **内部ネットワークから各サービスにアクセスできることを確認**
   ```bash
   curl http://192.168.68.110:9001
   curl http://192.168.68.110:8001
   curl http://192.168.68.110:8080
   ```

2. **外部からHTTPSでアクセスできることを確認**
   ```bash
   curl -I https://yoshi-nas-sys.duckdns.org:8443
   ```

3. **外部から直接ポートでアクセスできないことを確認**
   ```bash
   curl -I http://yoshi-nas-sys.duckdns.org:9001
   # タイムアウトまたは接続拒否が期待される
   ```

---

## 🔧 UFWとの関係

### 組み込みファイアウォールとUFWの競合

NASの組み込みファイアウォールとUFWは、同じシステムレベルのファイアウォール（iptablesやnftables）を管理するため、**同時に使用することは推奨されません**。

**推奨される使用方法**:
- **組み込みファイアウォールを使用する場合**: UFWは無効化または使用しない
- **UFWを使用する場合**: 組み込みファイアウォールは無効化する

### 組み込みファイアウォールを使用する場合

組み込みファイアウォールを使用する場合、UFWのインストールは不要です。組み込みファイアウォールで全ての設定を行います。

### UFWを使用する場合

UFWを使用する場合、組み込みファイアウォールを無効化し、UFWで全ての設定を行います。

---

## 📊 設定後の確認

### 1. ファイアウォールの状態確認

NAS管理画面の「セキュリティ」→「ファイアウォール」で、ファイアウォールが有効化されていることを確認します。

### 2. ポート設定の確認

各ポートの設定が正しく行われていることを確認します：
- 外部から許可するポート: 8443, 23456
- 内部ネットワークからのみ許可するポート: 9001, 8001, 8080, 5002, 3002, 8002, 8111, 8181

### 3. アクセステスト

#### 内部ネットワークからのアクセステスト

```bash
# 内部ネットワークから全てのポートにアクセスできることを確認
curl http://192.168.68.110:9001
curl http://192.168.68.110:8001
curl http://192.168.68.110:8080
curl http://192.168.68.110:5002
```

#### 外部からのアクセステスト

```bash
# 外部からHTTPSでアクセスできることを確認
curl -I https://yoshi-nas-sys.duckdns.org:8443

# 外部から直接ポートでアクセスできないことを確認（例: 9001）
curl -I http://yoshi-nas-sys.duckdns.org:9001
# タイムアウトまたは接続拒否が期待される
```

---

## 🔔 通知機能の活用

### ファイアウォール通知の設定

組み込みファイアウォールの通知機能を有効化すると、以下の場合に通知が送信されます：

1. **不正アクセス試行の検出**
   - ブロックされたIPアドレス
   - ブロックされたポート
   - ブロックされた時間

2. **迅速な解除オプション**
   - 通知から直接ブロックを解除できる
   - 一時的な許可を設定できる

### 通知の確認方法

1. **NAS管理画面の通知センター**
   - 左メニューから「通知」を選択
   - ファイアウォール関連の通知を確認

2. **メール通知（設定している場合）**
   - ファイアウォールがブロックした場合にメール通知が送信される

---

## 🔧 トラブルシューティング

### ファイアウォールを無効化する（緊急時）

SSH接続が切断された場合、内部ネットワークからNAS管理画面にアクセスして、ファイアウォールを一時的に無効化できます。

1. **NAS管理画面にアクセス**
   - 内部ネットワークから: `http://192.168.68.110`

2. **セキュリティ設定に移動**
   - 左メニューから「セキュリティ」を選択
   - 「ファイアウォール」タブをクリック

3. **ファイアウォールを無効化**
   - 「ファイアウォール」セクションのトグルスイッチを**オフ**にする

### 特定のポートを一時的に許可する

1. **ポート設定画面でポートを追加**
2. **ソースIPアドレスを「Anywhere」に設定**
3. **アクションを「許可」に設定**
4. **設定を保存**

---

## 📚 参考資料

- **外部アクセス時のセキュリティ対策ガイド**: `docs/deployment/EXTERNAL_ACCESS_SECURITY.md`
- **セキュリティチェックリスト**: `docs/deployment/SECURITY_CHECKLIST.md`
- **UFW設定ガイド**: `docs/deployment/UFW_INSTALL_SETUP.md`（UFWを使用する場合）

---

## ✅ チェックリスト

組み込みファイアウォール設定前の確認：

- [ ] NAS管理画面にアクセスできる
- [ ] セキュリティ設定画面にアクセスできる
- [ ] ファイアウォール設定画面が表示される

組み込みファイアウォール設定後の確認：

- [ ] ファイアウォールが有効化されている
- [ ] ファイアウォール通知が有効化されている
- [ ] 外部からHTTPS（8443）でアクセスできる
- [ ] 外部からSSH（23456）でアクセスできる（必要に応じて）
- [ ] 内部ネットワークから全てのポートにアクセスできる
- [ ] 外部から直接ポート（9001, 8001など）でアクセスできない

---

**作成日**: 2025-01-27  
**更新日**: 2025-01-27

