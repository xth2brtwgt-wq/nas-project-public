# 🔧 ファイアウォールが接続を切断する問題の解決

**作成日**: 2025-01-27  
**対象**: ファイアウォールが原因で接続が切断される問題の解決

---

## 📋 概要

ファイアウォールをOFFにすると正常に動作するが、ONにすると接続が切断される問題の解決方法を説明します。

この問題は、ファイアウォールの設定が正しく適用されていない、または接続の状態管理（ステートフルファイアウォール）に問題がある可能性があります。

---

## 🔍 問題の原因

### 考えられる原因

1. **ファイアウォールのルールの優先順位が間違っている**
2. **ファイアウォールの設定が正しく適用されていない**
3. **ファイアウォールが接続を途中で切断している（ステートフルファイアウォールの問題）**
4. **ファイアウォールのデフォルトポリシーが拒否になっているが、許可ルールが正しく適用されていない**
5. **ファイアウォールがHTTPS接続の確立を妨げている**

---

## ✅ 解決方法

### ステップ1: ファイアウォールの設定を再確認

**NAS管理画面で確認**:
1. **NAS管理画面にアクセス**
   - `http://192.168.68.110`

2. **セキュリティ → ファイアウォール** を開く

3. **ファイアウォールの状態を確認**
   - ファイアウォールが有効化されているか確認
   - ファイアウォール通知が有効化されているか確認

4. **ファイアウォールルールの一覧を確認**
   - ルールの順序を確認（上から順に処理される）
   - 各ルールが有効化されているか確認

---

### ステップ2: ルールの順序を確認・修正

**推奨されるルールの順序**:
1. **内部ネットワーク（192.168.68.0/24）からの全アクセスを許可**（最も優先度が高い）
2. **外部からのHTTPS（8443）アクセスを許可**
3. **外部からのSSH（23456）アクセスを許可**

**重要**: ルールは上から順に処理されるため、許可ルールを拒否ルールより前に配置する必要があります。

**ルールの順序を変更する方法**:
- ルール一覧画面で、ルールをドラッグ&ドロップで並び替えられる場合があります
- または、ルールを削除して再作成する順序で調整してください

---

### ステップ3: 8443ポートのルールを再作成

**既存のルールを削除して再作成**:
1. **既存の8443ポートのルールを削除**
   - ルール一覧から8443ポートのルールを削除

2. **新しいルールを作成**
   - 「新規ルール」ボタンをクリック
   - 以下の設定でルールを作成：
     - **権限**: **許可** を選択
     - **ネットワーク接続**: **ALL** を選択
     - **ポート**: **カスタマイズ** を選択
       - 入力フィールドに `8443` と入力
     - **タイプ**: **ターゲットポート** を選択
       - ⚠️ **重要**: 「ターゲットポート」を選択してください
     - **ソースIP**: **すべて** を選択
     - 「OK」をクリックして保存

3. **ルールの順序を確認**
   - ルールが正しい順序になっているか確認
   - 内部ネットワークのルールが最初に配置されているか確認

---

### ステップ4: デフォルトポリシーを確認

**NAS管理画面で確認**:
1. **セキュリティ → ファイアウォール** を開く

2. **デフォルトポリシーを確認**
   - 「上記のルールのいずれにも該当しない場合」の設定を確認
   - **推奨**: 「アクセスを拒否」を選択

3. **デフォルトポリシーが正しく設定されているか確認**
   - 許可ルールが正しく適用されるように、デフォルトポリシーを「アクセスを拒否」に設定

---

### ステップ5: ファイアウォールを再起動

**設定を保存した後**:
1. **ファイアウォールを一度OFFにする**
   - ファイアウォールのトグルスイッチをOFFにする

2. **設定を保存**

3. **ファイアウォールを再度ONにする**
   - ファイアウォールのトグルスイッチをONにする

4. **設定を保存**

これにより、ファイアウォールの設定が再読み込みされ、正しく適用されます。

---

### ステップ6: 接続をテスト

**設定を保存した後**:
1. **外部からアクセスをテスト**
   - `https://yoshi-nas-sys.duckdns.org:8443` にアクセス
   - 接続が切断されないことを確認

2. **各サービスにアクセスをテスト**
   - `/analytics`
   - `/monitoring`
   - `/meetings`
   - `/documents`
   - `/youtube`

---

## 🔍 トラブルシューティング

### 問題1: ルールを作成したが、まだ接続が切断される

**確認項目**:
1. ルールの順序を確認（許可ルールが拒否ルールより前に配置されているか）
2. ルールの設定が正しく保存されているか確認
3. ポート番号が正しいか確認（8443）
4. タイプが「ターゲットポート」になっているか確認

**解決方法**:
- ルールを削除して再作成する
- ルールの順序を変更する
- ファイアウォールを一度OFFにして、再度ONにする

---

### 問題2: 内部ネットワークからも接続が切断される

**確認項目**:
1. 内部ネットワーク（192.168.68.0/24）からの全アクセスを許可するルールが作成されているか
2. ルールの優先順位を確認（内部ネットワークのルールが最初に配置されているか）

**解決方法**:
- 内部ネットワークからの全アクセスを許可するルールを最初に配置する
- ルールの順序を変更する

---

### 問題3: HTTPS接続が確立されない

**確認項目**:
1. 8443ポートのルールが正しく作成されているか
2. タイプが「ターゲットポート」になっているか
3. プロトコルがTCPになっているか

**解決方法**:
- 8443ポートのルールを再作成する
- タイプを「ターゲットポート」に設定する
- プロトコルをTCPに設定する

---

### 問題4: 接続が途中で切断される

**確認項目**:
1. ファイアウォールがステートフルファイアウォールかどうか確認
2. 接続の状態管理が正しく行われているか確認

**解決方法**:
- ファイアウォールの設定を確認
- ステートフルファイアウォールの場合は、接続の状態管理を確認
- 必要に応じて、ファイアウォールの設定を調整

---

## 📊 推奨されるファイアウォール設定のまとめ

### ルール1: 内部ネットワークからの全アクセスを許可

- **権限**: 許可
- **ネットワーク接続**: ALL
- **ポート**: すべて
- **ソースIP**: 192.168.68.0/24
- **優先順位**: 1（最も高い）

### ルール2: 外部からのHTTPS（8443）アクセスを許可

- **権限**: 許可
- **ネットワーク接続**: ALL
- **ポート**: 8443
- **タイプ**: ターゲットポート
- **プロトコル**: TCP
- **ソースIP**: すべて
- **優先順位**: 2

### ルール3: 外部からのSSH（23456）アクセスを許可

- **権限**: 許可
- **ネットワーク接続**: ALL
- **ポート**: 23456
- **タイプ**: ターゲットポート
- **プロトコル**: TCP
- **ソースIP**: すべて
- **優先順位**: 3

### デフォルトポリシー

- **上記のルールのいずれにも該当しない場合**: アクセスを拒否

---

## ⚠️ 重要な注意事項

### ファイアウォールをOFFにしたままにしない

- ⚠️ **ファイアウォールをOFFにしたままにすると、セキュリティリスクが高まります**
- ✅ **ファイアウォールを有効化し、正しい設定を行うことを推奨します**

### SSH接続を確保する

ファイアウォールを有効化する前に、必ずSSHポート（23456）を許可するルールを作成してください。SSH接続が切断されると、リモートからアクセスできなくなります。

**推奨される設定順序**:
1. まず、SSH（23456）の許可ルールを作成
2. 次に、内部ネットワーク（192.168.68.0/24）の許可ルールを作成
3. 最後に、HTTPS（8443）の許可ルールを作成
4. すべてのルールを作成した後、ファイアウォールを有効化

---

## 📚 参考資料

- **NAS組み込みファイアウォール設定ガイド**: `docs/deployment/NAS_BUILTIN_FIREWALL_SETUP.md`
- **ファイアウォールで8443ポートへのアクセスがブロックされる問題の解決**: `docs/deployment/FIREWALL_8443_ACCESS_FIX.md`
- **ファイアウォールによるアクセス問題の解決**: `docs/deployment/FIREWALL_ACCESS_ISSUE_FIX.md`

---

**作成日**: 2025-01-27  
**更新日**: 2025-01-27

