# 🔧 ファイアウォールで8443ポートへのアクセスがブロックされる問題の解決

**作成日**: 2025-01-27  
**対象**: ファイアウォールが原因でNASシステムにアクセスできない問題の解決

---

## 📋 概要

ファイアウォールを有効化すると、外部からの8443ポートへのアクセスがブロックされ、NASシステムにアクセスできなくなる問題の解決方法を説明します。

---

## 🔍 問題の原因

### 確認結果

- ✅ Nginx Proxy Managerのコンテナは正常に稼働中
- ✅ Nginxの設定ファイルの構文は正常
- ✅ ファイアウォールをOFFにするとアクセスできる
- ⚠️ **ファイアウォールの設定が正しく適用されていない、またはルールの優先順位が間違っている**

**考えられる原因**:
1. 外部からの8443ポートへのアクセスを許可するルールが作成されていない
2. ルールの優先順位が間違っている（拒否ルールが先に適用されている）
3. ルールの設定が正しく保存されていない
4. ファイアウォールが有効化されていない

---

## ✅ 解決方法

### ステップ1: ファイアウォールの設定を確認

**NAS管理画面での確認**:
1. **NAS管理画面にアクセス**
   - `http://192.168.68.110`

2. **セキュリティ → ファイアウォール** を開く

3. **ファイアウォールの状態を確認**
   - ファイアウォールが有効化されているか確認
   - ファイアウォール通知が有効化されているか確認

4. **ファイアウォールルールの一覧を確認**
   - 外部からの8443ポートへのアクセスを許可するルールが存在するか確認
   - ルールの優先順位を確認（上から順に処理される）

---

### ステップ2: ファイアウォールルールの作成・修正

**推奨されるルールの順序**:
1. **内部ネットワーク（192.168.68.0/24）からの全アクセスを許可**（最も優先度が高い）
2. **外部からのHTTPS（8443）アクセスを許可**
3. **外部からのSSH（23456）アクセスを許可**

**重要**: ルールは上から順に処理されるため、許可ルールを拒否ルールより前に配置する必要があります。

---

#### ルール1: 内部ネットワークからの全アクセスを許可

**設定内容**:
- **権限**: **許可** を選択
- **ネットワーク接続**: デフォルト（すべて）のまま
- **ポート**: **すべて** を選択
- **タイプ**: **ターゲットポート** を選択（ポートが「すべて」の場合は不要）
- **ソースIP**: **特定のIPアドレス** を選択
  - 「選択」ボタンをクリック
  - 「サブネット」を選択
  - **IPアドレス**: `192.168.68.0`
  - **ネットワークプレフィックス長**: `24`
  - 「OK」をクリック
- 「OK」をクリックしてルールを保存

**このルールにより、内部ネットワークから以下のポートにアクセス可能になります**:
- 9001: nas-dashboard
- 8001: amazon-analytics
- 8080: document-automation
- 5002: meeting-minutes-byc
- 3002: nas-dashboard-monitoring (frontend)
- 8002: nas-dashboard-monitoring (backend)
- 8111: youtube-to-notion
- 8181: Nginx Proxy Manager Admin
- 8443: Nginx Proxy Manager (HTTPS)

---

#### ルール2: 外部からのHTTPS（8443）アクセスを許可

**設定内容**:
- **権限**: **許可** を選択
- **ネットワーク接続**: デフォルト（すべて）のまま
- **ポート**: **カスタマイズ** を選択
  - 入力フィールドに `8443` と入力
- **タイプ**: **ターゲットポート** を選択
  - ⚠️ **重要**: 外部からのHTTPS（8443）アクセスを許可する場合は、**「ターゲットポート」**を選択してください
  - **「ターゲットポート」**: NAS側で待ち受けるポート（宛先ポート）を指定します
  - **「ソースポート」**: クライアント側が使用するポートを指定します（通常は動的に割り当てられるため、指定する必要はありません）
- **ソースIP**: **すべて** を選択（外部からのアクセスはどのIPからでも受け付けるため）
- 「OK」をクリックして保存

**このルールにより、外部から以下のポートにアクセス可能になります**:
- 8443: Nginx Proxy Manager (HTTPS)

---

#### ルール3: 外部からのSSH（23456）アクセスを許可

**設定内容**:
- **権限**: **許可** を選択
- **ネットワーク接続**: デフォルト（すべて）のまま
- **ポート**: **カスタマイズ** を選択
  - 入力フィールドに `23456` と入力
- **タイプ**: **ターゲットポート** を選択
- **ソースIP**: **すべて** を選択
  - ⚠️ **セキュリティをさらに高める場合**: 特定の管理用IPアドレスのみを許可することも検討できます
    - その場合は「特定のIPアドレス」を選択
    - 「選択」ボタンをクリック
    - 「サブネット」を選択し、管理者の固定IPアドレス範囲を入力（例: `123.45.67.0/24`）
    - または「単一ホスト」を選択し、管理者の固定IPアドレスを入力（例: `123.45.67.89`）
- 「OK」をクリックして保存

**このルールにより、外部から以下のポートにアクセス可能になります**:
- 23456: SSH（管理用）

---

### ステップ3: ルールの優先順位を確認

**重要**: ファイアウォールのルールは通常、上から順に処理されます。

**推奨されるルールの順序**:
1. **内部ネットワークからの全アクセスを許可**（最も広範なルール）
2. **外部からのHTTPS（8443）アクセスを許可**（特定ポート）
3. **外部からのSSH（23456）アクセスを許可**（特定ポート）

この順序により、内部ネットワークからのアクセスが優先され、外部からのアクセスは特定のポートのみが許可されます。

**ルールの順序を変更する方法**:
- ルール一覧画面で、ルールをドラッグ&ドロップで並び替えられる場合があります
- または、ルールを削除して再作成する順序で調整してください

---

### ステップ4: ファイアウォールを有効化

1. **ファイアウォール機能を有効化**
   - 「ファイアウォール」セクションのトグルスイッチを**オン**にする

2. **ファイアウォール通知を有効化（推奨）**
   - 「ファイアウォール通知」のチェックボックスを**オン**にする

3. **設定を保存**

---

## 🔍 トラブルシューティング

### 問題1: ルールを作成したが、まだアクセスできない

**確認項目**:
1. ファイアウォールが有効化されているか確認
2. ルールの優先順位を確認（許可ルールが拒否ルールより前に配置されているか）
3. ルールの設定が正しく保存されているか確認
4. ポート番号が正しいか確認（8443）

**解決方法**:
- ルールを削除して再作成する
- ルールの順序を変更する
- ファイアウォールを一度OFFにして、再度ONにする

---

### 問題2: 内部ネットワークからもアクセスできない

**確認項目**:
1. 内部ネットワーク（192.168.68.0/24）からの全アクセスを許可するルールが作成されているか
2. ルールの優先順位を確認（内部ネットワークのルールが最初に配置されているか）

**解決方法**:
- 内部ネットワークからの全アクセスを許可するルールを最初に配置する
- ルールの順序を変更する

---

### 問題3: ファイアウォール通知が表示されない

**確認項目**:
1. ファイアウォール通知が有効化されているか確認
2. 通知設定を確認

**解決方法**:
- ファイアウォール通知を有効化する
- 通知設定を確認する

---

## 📊 推奨されるファイアウォール設定のまとめ

### ルール1: 内部ネットワークからの全アクセスを許可

- **権限**: 許可
- **ポート**: すべて
- **ソースIP**: 192.168.68.0/24

### ルール2: 外部からのHTTPS（8443）アクセスを許可

- **権限**: 許可
- **ポート**: 8443
- **タイプ**: ターゲットポート
- **ソースIP**: すべて

### ルール3: 外部からのSSH（23456）アクセスを許可

- **権限**: 許可
- **ポート**: 23456
- **タイプ**: ターゲットポート
- **ソースIP**: すべて

---

## ⚠️ 重要な注意事項

### ファイアウォールをOFFにしたままにしない

- ⚠️ **ファイアウォールをOFFにしたままにすると、セキュリティリスクが高まります**
- ✅ **ファイアウォールを有効化し、正しい設定を行うことを推奨します**

### SSH接続を確保する

ファイアウォールを有効化する前に、必ずSSHポート（23456）を許可するルールを作成してください。SSH接続が切断されると、リモートからアクセスできなくなります。

**推奨される設定順序**:
1. まず、SSH（23456）の許可ルールを作成
2. 次に、内部ネットワーク（192.168.68.0/24）の許可ルールを作成
3. 最後に、HTTPS（8443）の許可ルールを作成
4. すべてのルールを作成した後、ファイアウォールを有効化

---

## 📚 参考資料

- **NAS組み込みファイアウォール設定ガイド**: `docs/deployment/NAS_BUILTIN_FIREWALL_SETUP.md`
- **ファイアウォールによるアクセス問題の解決**: `docs/deployment/FIREWALL_ACCESS_ISSUE_FIX.md`

---

**作成日**: 2025-01-27  
**更新日**: 2025-01-27

