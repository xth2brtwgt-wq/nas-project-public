# 🔒 Nginxアクセスログ監視のホワイトリスト設定

**作成日**: 2025-11-07  
**対象**: Nginxアクセスログ監視システムのホワイトリスト機能

---

## 📋 概要

Nginxアクセスログ監視システムに、IPアドレスのホワイトリスト機能を追加しました。ホワイトリストに登録されたIPアドレスからのアクセスは、異常検知の通知対象外となります。

---

## ✅ 実装内容

### ホワイトリストIPアドレス

以下のIPアドレスがホワイトリストに登録されています：

```python
self.whitelist_ips = [
    '58.183.58.145',  # ユーザー自身のIPアドレス（岡山県）
    '127.0.0.1',      # ローカルホスト
    '::1',            # IPv6ローカルホスト
]
```

### 動作

- ホワイトリストに登録されたIPアドレスからのアクセスは、異常検知の対象外となります
- リクエスト数の監視は継続されますが、通知は送信されません
- 攻撃パターンの検出も継続されますが、通知は送信されません

---

## 🔧 設定方法

### ホワイトリストにIPアドレスを追加する場合

**ファイル**: `nas-dashboard-monitoring/app/services/nginx_log_monitor.py`

```python
# ホワイトリストIPアドレス（通知を送信しない）
self.whitelist_ips = [
    '58.183.58.145',  # ユーザー自身のIPアドレス（岡山県）
    '127.0.0.1',      # ローカルホスト
    '::1',            # IPv6ローカルホスト
    '192.168.1.100',  # 追加するIPアドレス
]
```

### 設定を反映する方法

1. **ローカルで修正**
   ```bash
   cd ~/nas-project/nas-dashboard-monitoring
   nano app/services/nginx_log_monitor.py
   # whitelist_ipsにIPアドレスを追加
   ```

2. **コミット・プッシュ**
   ```bash
   git add app/services/nginx_log_monitor.py
   git commit -m "feat: ホワイトリストにIPアドレスを追加"
   git push origin main
   ```

3. **NAS環境にデプロイ**
   ```bash
   ssh -p 23456 AdminUser@192.168.68.110 "cd ~/nas-project && git pull origin main && cd nas-dashboard-monitoring && docker compose restart backend"
   ```

---

## 📊 動作確認

### ログで確認

```bash
# バックエンドのログを確認
docker compose logs backend --tail 50 | grep -i 'whitelist\|nginx\|監視'
```

### 通知の確認

ホワイトリストに登録されたIPアドレスからのアクセスでは、以下の通知は送信されません：

- 高リクエストレート（1分間に100回以上）
- 高時間リクエスト（1時間に1000回以上）
- 大量の404エラー（1分間に20回以上）
- 大量の401エラー（1分間に10回以上）
- 大量の403エラー（1分間に10回以上）

---

## ⚠️ 注意事項

### セキュリティ上の考慮

- ホワイトリストに登録されたIPアドレスは、異常検知の通知対象外となります
- 攻撃パターンの検出は継続されますが、通知は送信されません
- 信頼できるIPアドレスのみをホワイトリストに追加してください

### 推奨事項

- 自分のIPアドレスをホワイトリストに追加することを推奨します
- 社内ネットワークのIPアドレス範囲を追加する場合は、慎重に検討してください
- 定期的にホワイトリストを見直し、不要なIPアドレスを削除してください

---

## 🔄 更新履歴

- **2025-11-07**: IPアドレスのホワイトリスト機能を追加
  - ユーザー自身のIPアドレス（58.183.58.145）をホワイトリストに追加
  - ローカルホスト（127.0.0.1、::1）をホワイトリストに追加

