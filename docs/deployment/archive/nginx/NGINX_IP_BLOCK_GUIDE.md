# 🚫 Nginx Proxy ManagerでIPアドレスをブロックする方法

**作成日**: 2025-11-07  
**対象**: 不明なアクセスを検出したIPアドレスのブロック

---

## 📋 概要

Nginx Proxy ManagerのCustom Nginx Configurationを使用して、特定のIPアドレスからのアクセスをブロックする方法です。

---

## ✅ 実装方法

### ステップ1: Nginx Proxy ManagerのWeb UIにアクセス

1. **Nginx Proxy ManagerのWeb UIにアクセス**: `http://192.168.68.110:8181`

2. **「Proxy Hosts」タブを開く**

3. **`yoshi-nas-sys.duckdns.org`のProxy Hostを編集**

4. **「Advanced」タブを開く**

5. **「Custom Nginx Configuration」の先頭に以下を追加**:

```nginx
# ==========================================
# IPアドレスブロックリスト（ブラックリスト）
# ==========================================
# 不正アクセスを検出したIPアドレスをブロック
# 2025-11-07: 51.159.103.26 (フランス・Scaleway) - 404エラー21回を検出
deny 51.159.103.26;
```

6. **「Save」をクリック**

---

## 📝 設定例

### 複数のIPアドレスをブロックする場合

```nginx
# ==========================================
# IPアドレスブロックリスト（ブラックリスト）
# ==========================================
# 不正アクセスを検出したIPアドレスをブロック

# 2025-11-07: 51.159.103.26 (フランス・Scaleway) - 404エラー21回を検出
deny 51.159.103.26;

# 他のブロック対象IPアドレス
# deny 192.168.1.100;
# deny 10.0.0.50;
```

### IPアドレス範囲をブロックする場合

```nginx
# IPアドレス範囲をブロック
deny 192.168.1.0/24;  # 192.168.1.0 ～ 192.168.1.255
deny 10.0.0.0/8;      # 10.0.0.0 ～ 10.255.255.255
```

---

## 🔍 動作確認

### ブロックされたIPアドレスからのアクセス

ブロックされたIPアドレスからアクセスすると、以下のエラーが返されます：

- **ステータスコード**: `403 Forbidden`
- **エラーメッセージ**: "403 Forbidden" または "Access denied"

### ログで確認

```bash
# Nginx Proxy Managerのアクセスログを確認
docker logs nginx-proxy-manager --tail 100 | grep "51.159.103.26"

# 403エラーが記録されていることを確認
```

---

## ⚠️ 注意事項

### 設定の優先順位

- `deny`ディレクティブは、`location`ブロックの前に記述すると、すべてのパスに適用されます
- 特定のパスのみをブロックする場合は、`location`ブロック内に記述します

### 誤ってブロックした場合

1. **Nginx Proxy ManagerのWeb UIにアクセス**
2. **「Proxy Hosts」タブを開く**
3. **`yoshi-nas-sys.duckdns.org`のProxy Hostを編集**
4. **「Advanced」タブを開く**
5. **「Custom Nginx Configuration」から該当の`deny`行を削除**
6. **「Save」をクリック**

---

## 🔄 管理方法

### ブロックリストの管理

- **追加**: Custom Nginx Configurationに`deny IPアドレス;`を追加
- **削除**: Custom Nginx Configurationから該当の`deny`行を削除
- **確認**: ログで403エラーが記録されていることを確認

### コメントの追加

各`deny`行にコメントを追加することで、ブロック理由を記録できます：

```nginx
# 2025-11-07: 51.159.103.26 (フランス・Scaleway) - 404エラー21回を検出
deny 51.159.103.26;
```

---

## 📊 現在ブロックされているIPアドレス

- **51.159.103.26** (フランス・Scaleway) - 2025-11-07: 404エラー21回を検出

---

## 🔗 関連ドキュメント

- [Nginx Proxy Manager 最終設定](NGINX_FINAL_CONFIG.md)
- [Nginxアクセスログ監視](NGINX_ACCESS_LOG_MONITORING.md)

