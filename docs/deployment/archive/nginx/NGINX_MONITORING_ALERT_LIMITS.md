# 🔔 Nginxアクセスログ監視の通知制限機能

**作成日**: 2025-11-07  
**対象**: Nginxアクセスログ監視システムの通知制限機能

---

## 📋 概要

Nginxアクセスログ監視システムに、通知が飛びっぱなしになることを防ぐための制限機能を追加しました。

---

## ✅ 実装内容

### 通知制限の仕組み

1. **クールダウン時間**: 2時間
   - 同じIPアドレスからの同じ異常タイプのアラートは、2時間間隔で送信されます
   - 例：`192.168.1.100`からの`high_request_rate`アラートは、2時間に1回のみ送信

2. **1日の最大通知数**: 5回/IPアドレス
   - 1つのIPアドレスから1日に送信する最大通知数を5回に制限
   - 5回に達した場合は、そのIPアドレスからの通知を24時間停止

3. **ホワイトリスト機能**
   - ホワイトリストに登録されたIPアドレスからのアクセスは、通知対象外

---

## 🔧 設定方法

### 設定値の変更

**ファイル**: `nas-dashboard-monitoring/app/services/nginx_log_monitor.py`

```python
# アラート送信履歴（重複送信を防ぐ）
self.alert_history = {}
self.alert_cooldown_minutes = 120  # 2時間は同じIPからの同じ異常タイプのアラートを送信しない
self.max_alerts_per_ip_per_day = 5  # 1つのIPアドレスから1日に送信する最大通知数
```

### 設定値の調整

- **クールダウン時間**: `alert_cooldown_minutes`を変更（分単位）
  - 例：`60`（1時間）、`240`（4時間）、`1440`（24時間）

- **1日の最大通知数**: `max_alerts_per_ip_per_day`を変更
  - 例：`3`（3回）、`10`（10回）、`0`（無制限、非推奨）

---

## 📊 動作例

### シナリオ1: 正常なアクセス（ホワイトリスト外）

1. **初回検出**: IP `192.168.1.100`から1分間に150回のリクエストを検出
   - ✅ 通知を送信（`high_request_rate`）

2. **2分後**: 同じIPから同じ異常タイプを検出
   - ❌ 通知をスキップ（クールダウン中、2時間経過していない）

3. **3時間後**: 同じIPから同じ異常タイプを検出
   - ✅ 通知を送信（2時間以上経過）

### シナリオ2: 継続的な異常アクセス

1. **1日目 09:00**: IP `192.168.1.200`から異常を検出
   - ✅ 通知を送信（1回目）

2. **1日目 11:00**: 同じIPから異常を検出（2時間経過）
   - ✅ 通知を送信（2回目）

3. **1日目 13:00**: 同じIPから異常を検出（2時間経過）
   - ✅ 通知を送信（3回目）

4. **1日目 15:00**: 同じIPから異常を検出（2時間経過）
   - ✅ 通知を送信（4回目）

5. **1日目 17:00**: 同じIPから異常を検出（2時間経過）
   - ✅ 通知を送信（5回目）

6. **1日目 19:00**: 同じIPから異常を検出（2時間経過）
   - ❌ 通知をスキップ（1日の最大通知数に達した）

7. **2日目 09:00**: 同じIPから異常を検出（24時間経過）
   - ✅ 通知を送信（1日の最大通知数の制限がリセット）

### シナリオ3: ホワイトリストIPアドレス

1. **ホワイトリストIP**: `58.183.58.145`から1分間に998回のリクエストを検出
   - ❌ 通知をスキップ（ホワイトリストに登録されている）

---

## ⚠️ 注意事項

### セキュリティ上の考慮

- 1日の最大通知数に達した場合でも、異常検知は継続されます
- データベースには異常データが保存されますが、通知は送信されません
- ダッシュボードで異常データを確認できます

### 推奨事項

- クールダウン時間は、2時間以上を推奨します
- 1日の最大通知数は、5回以下を推奨します
- 信頼できるIPアドレスは、ホワイトリストに追加してください

---

## 🔄 更新履歴

- **2025-11-07**: 通知制限機能を追加
  - クールダウン時間を30分から2時間に延長
  - 1日の最大通知数を5回に制限
  - 同じIPアドレスからの同じ異常タイプのアラートは2時間間隔で送信

