# 🔐 ダッシュボード認証統合 実装計画

**作成日**: 2025-11-04  
**目的**: ダッシュボード経由でのみ各サービスにアクセス可能にする仕組みを検討・実装

---

## 📋 現在の状況

### 現在の構成

- **ダッシュボード**: `nas-dashboard`（ポート9001）
  - 認証機能なし
  - 各サービスへのリンクを提供

- **各サービス**: 
  - `meeting-minutes-byc` (`/meetings`)
  - `amazon-analytics` (`/analytics`)
  - `nas-dashboard-monitoring` (`/monitoring`)
  - `document-automation` (`/documents`)
  - `youtube-to-notion` (`/youtube`)
  - すべてBasic認証で保護されている
  - 直接URLでアクセス可能

### 問題点

- 各サービスのURLを直接入力するとアクセス可能（Basic認証が必要だが、認証情報を知っていれば直接アクセス可能）
- ダッシュボード経由でのみアクセス可能にする仕組みがない
- ダッシュボードにログイン機能がない

---

## 🎯 要件

### 必須要件

1. **ダッシュボード経由でのみ各サービスにアクセス可能**
   - ダッシュボードにログイン後、各サービスにアクセス可能
   - 直接URLでアクセスした場合は拒否

2. **シンプルな実装**
   - 各サービスへの変更を最小限に
   - 既存の構成を大きく変更しない

3. **セキュリティ**
   - 認証情報の漏洩を防ぐ
   - セッション管理が可能

### 任意要件

- ユーザー体験が良い（シームレスな認証）
- セッションタイムアウト機能
- ログアウト機能

---

## 🔍 実装方法の選択肢

### オプション1: Basic認証のみ（現在の状態）

**実装内容**: 変更なし

**メリット**:
- 実装が簡単（既に実装済み）
- Nginx Proxy Managerで一元管理
- 追加のインフラが不要

**デメリット**:
- 各サービスのURLを直接入力するとアクセス可能
- ダッシュボード経由でのみアクセス可能にする仕組みがない
- 要件を満たさない

**評価**: ❌ **要件を満たさない**

---

### オプション2: Refererチェック

**実装内容**:
- 各サービスにRefererチェック機能を追加
- ダッシュボードからのアクセスのみ許可
- 直接URLでアクセスした場合は拒否

**メリット**:
- 実装が比較的簡単
- ダッシュボード経由でのみアクセス可能
- 既存の構成を大きく変更しない

**デメリット**:
- Refererヘッダーは偽造可能
- ブラウザによってはRefererが送信されない場合がある
- セキュリティが低い

**評価**: ⚠️ **セキュリティが低い**

---

### オプション3: トークンベース認証（推奨）

**実装内容**:
1. **ダッシュボード側**:
   - ログイン機能を追加
   - ログイン成功時にセッションID（トークン）を発行
   - セッションIDをCookieまたはURLパラメータで各サービスに渡す

2. **各サービス側**:
   - リクエストにセッションIDが含まれているかチェック
   - セッションIDが有効な場合のみアクセス許可
   - セッションIDがない、または無効な場合は拒否

3. **セッション管理**:
   - セッションIDをRedisまたはデータベースに保存
   - セッションタイムアウト機能
   - ログアウト時にセッションを無効化

**メリット**:
- セキュリティが高い
- セッション管理が可能
- 要件を満たす

**デメリット**:
- 実装が複雑
- 各サービスに認証機能を追加する必要がある
- セッション管理用のストレージが必要（Redisまたはデータベース）

**評価**: ✅ **推奨**

---

### オプション4: SSO（Single Sign-On）

**実装内容**:
- OAuth2/OIDCを使用
- ダッシュボードでログイン後、各サービスに自動的に認証情報を渡す

**メリット**:
- セキュリティが高い
- ユーザー体験が良い
- 業界標準の認証方式

**デメリット**:
- 実装が非常に複雑
- 追加のインフラが必要（OAuth2/OIDCプロバイダー）
- 開発工数が大きい

**評価**: ❌ **実装が複雑すぎる**

---

## 🎯 推奨実装方法

### オプション3: トークンベース認証（推奨）

**理由**:
- 要件を満たす（ダッシュボード経由でのみアクセス可能）
- セキュリティが高い
- 実装が比較的現実的

**実装の詳細**:

#### 1. ダッシュボード側の実装

- **ログイン機能**:
  - ログインページを追加
  - ユーザー名とパスワードで認証
  - 認証成功時にセッションID（JWTまたはUUID）を発行
  - セッションIDをCookieに保存

- **セッション管理**:
  - セッションIDをRedisまたはSQLiteに保存
  - セッションタイムアウト（例：30分）
  - ログアウト時にセッションを無効化

- **各サービスへのリンク**:
  - セッションIDをURLパラメータまたはCookieで渡す
  - 例: `https://yoshi-nas-sys.duckdns.org:8443/meetings?token=xxx`

#### 2. 各サービス側の実装

- **認証ミドルウェア**:
  - リクエストにセッションIDが含まれているかチェック
  - セッションIDが有効な場合のみアクセス許可
  - セッションIDがない、または無効な場合は403エラーを返す

- **セッション検証**:
  - ダッシュボードのセッション管理APIに問い合わせ
  - または、共有のRedis/データベースからセッションを検証

#### 3. セッション管理の選択肢

**オプションA: Redis（推奨）**
- メリット: 高速、分散対応、TTL機能
- デメリット: 追加のインフラが必要

**オプションB: SQLite**
- メリット: 追加のインフラが不要、シンプル
- デメリット: パフォーマンスが低い（ただし、小規模な場合は問題なし）

**推奨**: SQLite（小規模な環境では十分）

---

## 📋 実装計画

### フェーズ1: ダッシュボード側の実装

1. **ログイン機能の追加**
   - ログインページ（`/login`）を作成
   - ユーザー名とパスワードで認証
   - セッションIDを発行してCookieに保存

2. **セッション管理機能の追加**
   - SQLiteデータベースにセッション情報を保存
   - セッションタイムアウト機能
   - ログアウト機能

3. **各サービスへのリンクにセッションIDを追加**
   - URLパラメータまたはCookieでセッションIDを渡す

### フェーズ2: 各サービス側の実装

1. **認証ミドルウェアの追加**
   - リクエストにセッションIDが含まれているかチェック
   - セッションIDを検証
   - 無効な場合は403エラーを返す

2. **セッション検証APIの呼び出し**
   - ダッシュボードのセッション検証APIに問い合わせ
   - または、共有のSQLiteデータベースからセッションを検証

### フェーズ3: テスト

1. **ダッシュボードからのアクセステスト**
   - ログイン後、各サービスにアクセス可能であることを確認

2. **直接アクセステスト**
   - 直接URLでアクセスした場合、403エラーが返されることを確認

---

## ✅ 実装チェックリスト

### フェーズ1: ダッシュボード側

- [ ] ログインページ（`/login`）を作成
- [ ] ユーザー名とパスワードで認証機能を実装
- [ ] セッションID発行機能を実装
- [ ] セッション管理用のSQLiteデータベースを作成
- [ ] セッションタイムアウト機能を実装
- [ ] ログアウト機能を実装
- [ ] 各サービスへのリンクにセッションIDを追加

### フェーズ2: 各サービス側

- [ ] 認証ミドルウェアを追加
- [ ] セッションID検証機能を実装
- [ ] セッション検証APIを実装（または共有データベースから検証）
- [ ] 無効なセッションIDの場合、403エラーを返す

### フェーズ3: テスト

- [ ] ダッシュボードからのアクセステスト
- [ ] 直接アクセステスト
- [ ] セッションタイムアウトのテスト
- [ ] ログアウトのテスト

---

## 📚 参考資料

- [現在の状況まとめ](CURRENT_STATUS_SUMMARY.md)
- [全サービスのサブフォルダ対応完了](ALL_SERVICES_SUBFOLDER_COMPLETE.md)

---

**作成日**: 2025-11-04  
**更新日**: 2025-11-04  
**作成者**: AI Assistant

