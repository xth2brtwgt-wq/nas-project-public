# 🔨 ダッシュボード認証 再ビルド手順

**作成日**: 2025-11-04  
**目的**: 認証機能が正しく動作するように、Dockerイメージを再ビルド

---

## ❌ 問題

- 起動ログに「認証データベースを初期化しました」が表示されない
- ルートパス`/`へのアクセスが`200`で返る（認証チェックが実行されていない）
- 認証関連のログが表示されない

---

## ✅ 解決方法: Dockerイメージを再ビルド

### ステップ1: 最新コードのプル

```bash
cd ~/nas-project/nas-dashboard
git pull origin feature/monitoring-fail2ban-integration
```

### ステップ2: コンテナの停止

```bash
cd ~/nas-project/nas-dashboard
sudo docker compose down
```

### ステップ3: Dockerイメージの再ビルド

```bash
cd ~/nas-project/nas-dashboard
sudo docker compose build --no-cache
```

**重要**: `--no-cache`オプションを使用して、キャッシュを使わずに再ビルドします。

### ステップ4: コンテナの起動

```bash
cd ~/nas-project/nas-dashboard
sudo docker compose up -d
```

### ステップ5: 起動ログの確認

```bash
cd ~/nas-project/nas-dashboard

# 起動ログを確認
sudo docker compose logs nas-dashboard | tail -30
```

以下のようなログが表示されれば正常です：

```
認証データベースを初期化しました
[2025-11-04 15:10:36 +0900] [1] [INFO] Starting gunicorn 21.2.0
[2025-11-04 15:10:36 +0900] [1] [INFO] Listening at: http://0.0.0.0:9000 (1)
```

### ステップ6: ブラウザでアクセスしてログを確認

1. **シークレットモード（プライベートモード）でアクセス**：
   - 外部アクセス: `https://yoshi-nas-sys.duckdns.org:8443/`
   - 内部アクセス: `http://192.168.68.110:9001/`

2. **リアルタイムでログを確認**（別ターミナルで実行）：

```bash
cd ~/nas-project/nas-dashboard
sudo docker compose logs -f nas-dashboard
```

ブラウザからアクセスした後、以下のようなログが表示されるはずです：

```
[AUTH] セッションIDがありません
[AUTH] 認証が必要です: /
192.168.160.1 - - [04/Nov/2025:15:14:43 +0900] "GET / HTTP/1.1" 302 ...
```

---

## 🔍 確認項目

- [ ] 最新コードがプルされている
- [ ] コンテナが停止されている
- [ ] Dockerイメージが再ビルドされている
- [ ] コンテナが起動している
- [ ] 起動ログに「認証データベースを初期化しました」が表示される
- [ ] ブラウザでアクセスした後、ログに認証関連のメッセージが表示される
- [ ] ログインページが表示される

---

## 🎯 期待される動作

1. シークレットモードでアクセス
2. ログに `[AUTH] セッションIDがありません` と `[AUTH] 認証が必要です: /` が表示される
3. ルートパス`/`へのアクセスログが`302`（リダイレクト）で返る
4. ログインページが表示される
5. 初期ユーザー（`admin`）でログイン
6. ダッシュボードにリダイレクトされる

---

## 📝 注意事項

- **再ビルドには時間がかかります**（数分程度）
- **`--no-cache`オプションを使用**して、確実に最新コードでビルドします
- **再ビルド後、コンテナが正常に起動することを確認**してください

---

**作成日**: 2025-11-04  
**更新日**: 2025-11-04  
**作成者**: AI Assistant

